function QBU(command_str,position)
% Create, store and show the question figure related to a setup.
%
%   Syntax:
%   QBU(command_str,position), where command_str is the desired action and
%   position is an optional 4 element vector for the question figure
%   position.
%
%   Needed predefined global variables: setup struct


global name standard setup


if nargin == 0
    command_str = 'initialize';
    position = [1 10 1500 740];
elseif nargin == 1
    position = [1 10 1500 740];
end
if ~strcmp(command_str,'initialize')
    % RETRIEVE HANDLES AND REDEFINE THE HANDLE VARIABLES.
    % Assume that the current figure contains the backgroundQuestions.
    h_fig = gcf;
    if ~strcmp(get(h_fig,'tag'),'QBU')
        % If the current figure does not have
        % the right tag, find the one that does.
        h_figs = get(0,'children');
        h_fig = findobj(h_figs,'flat', 'tag','QBU');
        
        if isempty(h_fig)
            % If the fun_plt4 GUI does not exist initialize it.
            % Then run the command string that was originally requested.
            QBU('initialize'); %first initialize
            QBU(command_str); %then run the required command
            return;
        end
    end
    
    % At this point we know that h_fig is the handle to the figure containing the GUI of interest to
    % this function. Therefore we can use this figure handle to cut down on the number of objects
    % that need to be searched for tag names as follows:
    
    h_panel2 = findobj(h_fig(1),'tag','panel2');
    h_panel3 = findobj(h_fig(1),'tag','panel3');
    h_panel4 = findobj(h_fig(1),'tag','panel4');
    h_panel5 = findobj(h_fig(1),'tag','panel5');
    h_panel6 = findobj(h_fig(1),'tag','panel6');
    h_panel7 = findobj(h_fig(1),'tag','panel7');
    h_panel8 = findobj(h_fig(1),'tag','panel8');
    
    overall_quality_panel = findobj(h_fig(1),'tag','quality_panel');
    h_checkBox1 = findobj(h_fig(1),'tag','checkBox1');
    
    focus_panel = findobj(h_fig(1),'tag','focus_panel');
    h_checkBox2 = findobj(h_fig(1),'tag','checkBox2');
    
    graininess_panel = findobj(h_fig(1),'tag','graininess_panel');
    h_checkBox3 = findobj(h_fig(1),'tag','checkBox3');
    
    lightness_panel = findobj(h_fig(1),'tag','lightness_panel');
    h_checkBox4 = findobj(h_fig(1),'tag','checkBox4');
    
    saturation_panel = findobj(h_fig(1),'tag','saturation_panel');
    h_checkBox5 = findobj(h_fig(1),'tag','checkBox5');
    
    % empty slider 1
    empty_panel1 = findobj(h_fig(1),'tag','empty_panel1');
    h_checkBox6 = findobj(h_fig(1),'tag','checkBox6');
    
    % empty slider 2
    empty_panel2 = findobj(h_fig(1),'tag','empty_panel2');
    h_checkBox7 = findobj(h_fig(1),'tag','checkBox7');
    
    % popups
    popups.popup1 = findobj(h_fig(1),'tag','popup1');
    popups.popup2 = findobj(h_fig(1),'tag','popup2');
    popups.popup3 = findobj(h_fig(1),'tag','popup3');
    h_checkBox8 = findobj(h_fig(1),'tag','checkBox8');
    h_checkBox9 = findobj(h_fig(1),'tag','checkBox9');
    h_checkBox10 = findobj(h_fig(1),'tag','checkBox10');
    
    % open questions
    h_checkBox11 = findobj(h_fig(1),'tag','checkBox11');
    h_checkBox12 = findobj(h_fig(1),'tag','checkBox12');
    h_checkBox13 = findobj(h_fig(1),'tag','checkBox13');
    h_checkBox14 = findobj(h_fig(1),'tag','checkBox14');
    %h_checkBox15 = findobj(h_fig(1),'tag','checkBox15');
    
    open.question_panel1 = findobj(h_fig(1),'tag','open1');
    open.question_panel2 = findobj(h_fig(1),'tag','open2');
    open.question_panel3 = findobj(h_fig(1),'tag','open3');
    open.question_panel4 = findobj(h_fig(1),'tag','open4');
    open.question_panel5 = findobj(h_fig(1),'tag','open5');
    
    open.question_box1 = findobj(h_fig(1),'tag','question_box1');
    open.question_box2 = findobj(h_fig(1),'tag','question_box2');
    open.question_box3 = findobj(h_fig(1),'tag','question_box3');
    open.question_box4 = findobj(h_fig(1),'tag','question_box4');
    
    % Checkbox questions
    h_checkBox16 = findobj(h_fig(1),'tag','checkBox16');
    h_checkBox17 = findobj(h_fig(1),'tag','checkBox17');
    h_checkBox18 = findobj(h_fig(1),'tag','checkBox18');
    h_checkBox19 = findobj(h_fig(1),'tag','checkBox19');
    h_checkBox20 = findobj(h_fig(1),'tag','checkBox20');
    h_checkBox21 = findobj(h_fig(1),'tag','checkBox21');
    
    boxes.box1 = findobj(h_fig(1),'tag','checkBox22');
    boxes.box2 = findobj(h_fig(1),'tag','checkBox23');
    boxes.box3 = findobj(h_fig(1),'tag','checkBox24');
    boxes.box4 = findobj(h_fig(1),'tag','checkBox25');
    boxes.box5 = findobj(h_fig(1),'tag','checkBox26');
    boxes.box6 = findobj(h_fig(1),'tag','checkBox27');
    
    % Radio buttons
    h_checkBox28 = findobj(h_fig(1),'tag','checkBox28');
    radio1.panel = findobj(h_fig(1),'tag','radio_panel');
    
    % Triplet slider group
    tripletCheckBox = findobj(h_fig(1),'tag','tripletCheckBox');
    triplet.empty_panel = findobj(h_fig,'tag','triplet_panel');
    
    % Continuous slider
    continuousCheckBox = findobj(h_fig(1),'tag','continuousCheckBox');
    continuous.empty_panel = findobj(h_fig(1),'tag','continuous_panel');
    
end

% INITIALIZE THE GUI SECTION.
if strcmp(command_str,'initialize')
    
    % Make sure that the GUI has not been already initialized in another existing figure.
    % NOTE THAT THIS GUI INSTANCE CHECK IS NOT REQUIRED, UNLESS YOU WANT TO INSURE THAT ONLY
    % ONE INSTANCE OF THE GUI IS CREATED!
    h_figs = get(0,'children');
    h_fig = findobj(h_figs,'flat', 'tag','QBU');
    if ~isempty(h_fig)
        figure(h_fig(1));
        return
    end
    
    % Main figure
    h_fig = figure('position',position, ...
        'name','QBU', ...
        'tag','QBU',...
        'toolbar','figure',...
        'menu','figure');
    
    % Modify the toolbar
    modifyToolbar(h_fig,findall(h_fig,'tag','FigureToolBar'));
    
    % Retrieve redo/undo object
    undoObj = getappdata(h_fig,'uitools_FigureToolManager');
    if isempty(undoObj)
        undoObj = uitools.FigureToolManager(h_fig);
        setappdata(h_fig,'uitools_FigureToolManager',undoObj);
    end
    
    %----------------------------------------------------------------------
    % Major panels
    
    % Panel for options
    h_panel1 = uipanel(h_fig, 'title', 'Options',...
        'Units', 'Normalized', ...
        'Position',[0.001 0.001 0.3 0.94], ...
        'Tag', 'panel1',...
        'hittest','off');
    
    % Find the right edge of the options panel in pixels
    set(h_panel1,'units','pixel')
    limits = get(h_panel1,'position');
    set(h_panel1,'units','normalized')
    
    % Panel for positions
    h_panel2 = uipanel(h_fig,'title', 'Component positions', ...
        'units','pixels',...
        'Position',[limits(3)+limits(1)+10 limits(1) 1024 740], ...
        'Tag', 'panel2',...
        'BackgroundColor', [0.85 0.85 0.85],...
        'hittest','off');
    
    % Create fake axis to the position panel
    %     plot(0);
    %     set(gca,'parent',h_panel2)
    %     axis off
    
    % Create fake annotation object to get the annotation layer
    a = annotation('arrow',[0 0],[0 0]);
    set(a,'visible','off')
    
    % Set new windowResizeFcn to main figure
    set(h_fig,'resizefcn',{@window_resize,h_panel1,h_panel2})
    
    % Panel for component position panel size
    size_panel = uipanel(h_fig,...
        'title','Question screen size',...
        'units','normalized',...
        'position',[0.001 0.94 0.3 0.06]);
    
    % Width
    uicontrol(size_panel,'style','edit',...
        'units','normalized',...
        'Position',[0 0.1 0.3 0.8], ...
        'string',setup.screens_info43,...
        'fontsize',12,...
        'back','white',...
        'callback',{@question_screen_width,h_panel2});
    
    % Width
    %uicontrol(size_panel,'style','edit',...
    %    'units','normalized',...
    %    'Position',[0 0.1 0.3 0.8], ...
    %    'string',1024,...
    %    'fontsize',12,...
    %    'back','white',...
    %    'callback',{@question_screen_width,h_panel2});
    
    % Text
    uicontrol(size_panel,'style','text',...
        'units','normalized',...
        'Position',[0.32 0.1 0.05 0.7], ...
        'string','x',...
        'fontsize',12);
    
    % Height
    uicontrol(size_panel,'style','edit',...
        'units','normalized',...
        'Position',[0.4 0.1 0.3 0.8], ...
        'string',setup.screens_info44,...
        'fontsize',12,...
        'back','white',...
        'callback',{@question_screen_height,h_panel2});
    
    % Height
    %uicontrol(size_panel,'style','edit',...
    %    'units','normalized',...
    %    'Position',[0.4 0.1 0.3 0.8], ...
    %    'string',740,...
    %    'fontsize',12,...
    %    'back','white',...
    %    'callback',{@question_screen_height,h_panel2});
    
    % Overlapping panel for the component options during move mode
    overlap_panel = uicontrol('Style','text',...
        'units','normalized',...
        'Position',[0 0 0.305 1], ...
        'String','Move mode active', ...
        'FontSize', 16,...
        'fore','red',...
        'visible','off',...
        'hittest','off');
    
    % Customize the move-tool callbacks
    mover = findall(findall(h_fig,'tag','FigureToolBar'),'tag','Standard.EditPlot');
    set(mover,'oncallback',{@mover_on,h_panel2,overlap_panel})
    set(mover,'offcallback',{@mover_off,h_panel2,overlap_panel})
    
    % Sub-panels-----------------------------------------------------------
    
    % Panel for slider selections
    h_panel3 = uipanel(h_panel1, 'title', 'Select sliders', ...
        'Units', 'Normalized', ...
        'Position',[0.01 0.001 0.98 0.9], ...
        'Tag', 'panel3', ...
        'visible','off',...
        'hittest','off');
    
    % Panel for check box selections
    h_panel4 = uipanel(h_panel1, 'title', 'Select check boxes', ...
        'Units', 'Normalized', ...
        'Position',[0.01 0.001 0.98 0.9], ...
        'Tag', 'panel4', ...
        'visible','off',...
        'hittest','off');
    
    % Panel for open question selections
    h_panel5 = uipanel(h_panel1, 'title', 'Select open questions', ...
        'Units', 'Normalized', ...
        'Position',[0.01 0.001 0.98 0.9], ...
        'Tag', 'panel5', ...
        'visible','off',...
        'hittest','off');
    
    % Panel for multiple choice selections
    h_panel6 = uipanel(h_panel1, 'title', 'Select multiple choices', ...
        'Units', 'Normalized', ...
        'Position',[0.01 0.001 0.98 0.9], ...
        'Tag', 'panel6', ...
        'visible','off',...
        'hittest','off');
    
    % Panel for miscellaneous selections
    h_panel7 = uipanel(h_panel1, 'title', 'Select miscellaneous options', ...
        'Units', 'Normalized', ...
        'Position',[0.01 0.001 0.98 0.9], ...
        'Tag', 'panel7', ...
        'visible','off',...
        'hittest','off');
    
    % Panel for custom components
    h_panel8 = uipanel(h_panel1, 'title', 'Select custom components', ...
        'Units', 'Normalized', ...
        'Position',[0.01 0.001 0.98 0.9], ...
        'Tag', 'panel8', ...
        'visible','off',...
        'hittest','off');
    
    %----------------------------------------------------------------------
    % Button group for qbu component selection
    
    h_buttongroup = uibuttongroup(h_panel1,'units','normalized', ...
        'Position',[0.01 0.9 .98 0.1]);
    
    % Create three radio buttons in the button group.
    uicontrol('Style','Radio', ...
        'units','normalized', ...
        'String','Sliders',...
        'pos',[0.01 0.7 .4 .2], ...
        'parent',h_buttongroup, ...
        'enable','on', ...
        'tag','ref_button1');
    
    uicontrol('Style','Radio', ...
        'units','normalized', ...
        'String','Check boxes',...
        'pos',[0.35 0.7 .4 .2], ...
        'parent',h_buttongroup, ...
        'enable','on', ...
        'tag','ref_button2');
    
    uicontrol('Style','Radio', ...
        'units','normalized', ...
        'String','Open questions',...
        'pos',[0.01 0.2 .4 .2], ...
        'parent',h_buttongroup, ...
        'enable','on', ...
        'tag','ref_button3');
    
    uicontrol('Style','Radio', ...
        'units','normalized', ...
        'String','Multiple choices',...
        'pos',[0.35 0.2 .4 .2], ...
        'parent',h_buttongroup, ...
        'enable','on', ...
        'tag','ref_button4');
    
    uicontrol('Style','Radio', ...
        'units','normalized', ...
        'String','Miscellaneous',...
        'pos',[0.7 0.2 .3 .2], ...
        'parent',h_buttongroup, ...
        'enable','on', ...
        'tag','ref_button5');
    
    uicontrol('Style','Radio', ...
        'units','normalized', ...
        'String','Custom',...
        'pos',[0.7 0.7 .3 .2], ...
        'parent',h_buttongroup, ...
        'enable','on', ...
        'tag','ref_button6');
    
    % Initialize some button group properties.
    set(h_buttongroup,'SelectionChangeFcn',@selcbk);
    set(h_buttongroup,'SelectedObject',[]);  % No selection
    set(h_buttongroup,'Visible','on');
    
    %----------------------------------------------------------------------
    
    % Overall image quality settings
    % create userdata struct
    userdata.isRandom = 'no';
    userdata.flowControl = 'off';
    %userdata.stopMessage = 'Et arvioinut kaikkia kohtia';
    userdata.stopMessage = 'You did not evaluated all items';
    userdata.isTouched = 'false';
    userdata.question = 'Slider1';
    userdata.isPlotting = 'false';
    
    % Overall quality slider
    overall.empty_panel = uipanel(h_panel2,'units','normalized',...
        'Position',[0.01 0.9 0.98 0.1],...
        'visible','off',...
        'tag','quality_panel',...
        'userdata',userdata,...
        'title','Slider1',...
        'fontsize',14,...
        'titleposition','centertop');
    
    overall.empty_min = uicontrol(overall.empty_panel, ...
        'Style','text',...
        'units','normalized',...
        'Position',[0.01 0.7 0.22 0.4], ...
        'String','min', ...
        'FontSize', 12,...
        'horizontal','left');
    
    overall.empty_max = uicontrol(overall.empty_panel, 'Style','text',...
        'units','normalized',...
        'Position',[0.77 0.7 0.22 0.4],...
        'String','max', ...
        'FontSize', 12,...
        'horizontal','right');
    
    overall.h_slider = uicontrol(overall.empty_panel, 'style','slider',...
        'units','normalized',...
        'position',[0.01 0.05 0.98 0.6], ...
        'tag','slider1',...
        'sliderstep',[.5 .01],...
        'max',100,...
        'min',0, ...
        'value', 100,...
        'CallBack',@slider_callback,...
        'BackgroundColor', [0.9 0.9 0.9],...
        'userdata',userdata,...
        'enable','off');
    
    overall.h_checkBox = uicontrol(h_panel3,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.95 0.99 0.04], ...
        'string','Slider1', ...
        'value',0,...
        'tag','checkBox1',...
        'CallBack',{@slider_checkbox_callback,overall},...
        'fontsize',10);
    
    %----------------------------------------------------------------------
    %  focus settings
    
    % create userdata struct
    userdata.isRandom = 'no';
    userdata.flowControl = 'off';
    %userdata.stopMessage = 'Et vastannut kaikkiin kohtiin';
    userdata.stopMessage = 'You did not answer all items';
    userdata.isTouched = 'false';
    userdata.question = 'Slider2';
    userdata.isPlotting = 'false';
    
    %  focus slider    
    focus.empty_panel = uipanel(h_panel2,...
        'units','normalized',...
        'Position',[0.01 0.8 0.98 0.1],...
        'visible','off',...
        'tag','focus_panel',...
        'userdata',userdata,...
        'title','Slider2',...
        'fontsize',14,...
        'titleposition','centertop');
    
    focus.h_slider = uicontrol(focus.empty_panel, ...
        'style','slider',...
        'units','normalized',...
        'position',[0.01 0.05 0.98 0.6], ...
        'tag','slider2',...
        'sliderstep',[.5 .01],...
        'max',100,...
        'min',0,...
        'value', 100,...
        'CallBack',@slider_callback,...
        'BackgroundColor', [0.9 0.9 0.9],...
        'userdata',userdata,...
        'enable','off');
    
    focus.empty_min = uicontrol(focus.empty_panel, ...
        'Style','text',...
        'units','normalized',...
        'Position',[0.01 0.7 0.09 0.4], ...
        'String','min', ...
        'FontSize', 12,...
        'horizontal','left');
    
    focus.empty_max = uicontrol(focus.empty_panel, 'Style','text',...
        'units','normalized',...
        'Position',[0.9 0.7 0.09 0.4],...
        'String','max',...
        'FontSize', 12,...
        'horizontal','right');
    
    focus.h_checkBox = uicontrol(h_panel3,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.90 0.99 0.04],...
        'string','Slider2', ...
        'value',0,...
        'tag','checkBox2',...
        'CallBack',{@slider_checkbox_callback,focus},...
        'fontsize',10);
    
    %----------------------------------------------------------------------
    %  graininess settings
    
    % create userdata struct
    userdata.isRandom = 'no';
    userdata.flowControl = 'off';
    %userdata.stopMessage = 'Et vastannut kaikkiin kohtiin';
    userdata.stopMessage = 'You did not answer all items';
    userdata.isTouched = 'false';
    userdata.question = 'Slider3';
    userdata.isPlotting = 'false';
    
    %  graininess slider    
    graininess.empty_panel = uipanel(h_panel2,...
        'units','normalized',...
        'Position',[0.01 0.7 0.98 0.1],...
        'visible','off',...
        'tag','graininess_panel',...
        'userdata',userdata,...
        'title','Slider3',...
        'fontsize',14,...
        'titleposition','centertop');
    
    graininess.h_slider = uicontrol(graininess.empty_panel, ...
        'style','slider',...
        'units','normalized',...
        'position',[0.01 0.05 0.98 0.6], ...
        'tag','slider3',...
        'sliderstep',[.5 .01],...
        'max',100,...
        'min',0,...
        'value', 100,...
        'CallBack',@slider_callback,...
        'BackgroundColor', [0.9 0.9 0.9],...
        'userdata',userdata,...
        'enable','off');
    
    graininess.empty_min = uicontrol(graininess.empty_panel, ...
        'Style','text',...
        'units','normalized',...
        'Position',[0.01 0.7 0.09 0.4], ...
        'String','min', ...
        'FontSize', 12,...
        'horizontal','left');
    
    graininess.empty_max = uicontrol(graininess.empty_panel, 'Style','text',...
        'units','normalized',...
        'Position',[0.88 0.7 0.11 0.4],...
        'String','max',...
        'FontSize', 12,...
        'horizontal','right');
    
    graininess.h_checkBox = uicontrol(h_panel3,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.85 0.99 0.04],...
        'string','Slider3', ...
        'value',0,...
        'tag','checkBox3',...
        'CallBack',{@slider_checkbox_callback,graininess},...
        'fontsize',10);
    
    %----------------------------------------------------------------------
    %  lightness settings
    
    % create userdata struct
    userdata.isRandom = 'no';
    userdata.flowControl = 'off';
    %userdata.stopMessage = 'Et vastannut kaikkiin kohtiin';
    userdata.stopMessage = 'You did not answer all items';
    userdata.isTouched = 'false';
    userdata.question = 'Slider4';
    userdata.isPlotting = 'false';
    
    %  lightness slider    
    lightness.empty_panel = uipanel(h_panel2,...
        'units','normalized',...
        'Position',[0.01 0.6 0.98 0.1],...
        'visible','off',...
        'tag','lightness_panel',...
        'userdata',userdata,...
        'title','Slider4',...
        'fontsize',14,...
        'titleposition','centertop');
    
    lightness.h_slider = uicontrol(lightness.empty_panel, ...
        'style','slider',...
        'units','normalized',...
        'position',[0.01 0.05 0.98 0.6], ...
        'tag','slider4',...
        'sliderstep',[.5 .01],...
        'max',100,...
        'min',0,...
        'value', 100,...
        'CallBack',@slider_callback,...
        'BackgroundColor', [0.9 0.9 0.9],...
        'userdata',userdata,...
        'enable','off');
    
    lightness.empty_min = uicontrol(lightness.empty_panel, ...
        'Style','text',...
        'units','normalized',...
        'Position',[0.01 0.7 0.13 0.4], ...
        'String','min', ...
        'FontSize', 12,...
        'horizontal','left');
    
    lightness.empty_max = uicontrol(lightness.empty_panel, ...
        'Style','text',...
        'units','normalized',...
        'Position',[0.86 0.7 0.13 0.4],...
        'String','max',...
        'FontSize', 12,...
        'horizontal','right');
    
    lightness.h_checkBox = uicontrol(h_panel3,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.80 0.99 0.04],...
        'string','Slider4', ...
        'value',0,...
        'tag','checkBox4',...
        'CallBack',{@slider_checkbox_callback,lightness},...
        'fontsize',10);
    
    %----------------------------------------------------------------------
    %  saturation settings
    
    % create userdata struct
    userdata.isRandom = 'no';
    userdata.flowControl = 'off';
    %userdata.stopMessage = 'Et vastannut kaikkiin kohtiin';
    userdata.stopMessage = 'You did not answer all items';
    userdata.isTouched = 'false';
    userdata.question = 'Slider5';
    userdata.isPlotting = 'false';
    
    % saturation slider    
    saturation.empty_panel = uipanel(h_panel2,...
        'units','normalized',...
        'Position',[0.01 0.5 0.98 0.1],...
        'visible','off',...
        'tag','saturation_panel',...
        'userdata',userdata,...
        'title','Slider5',...
        'fontsize',14,...
        'titleposition','centertop');
    
    saturation.h_slider = uicontrol(saturation.empty_panel, ...
        'style','slider',...
        'units','normalized',...
        'position',[0.01 0.05 0.98 0.6], ...
        'tag','slider5',...
        'sliderstep',[.5 .01],...
        'max',100,...
        'min',0,...
        'value', 100,...
        'CallBack',@slider_callback,...
        'BackgroundColor', [0.9 0.9 0.9],...
        'userdata',userdata,...
        'enable','off');
    
    saturation.empty_min = uicontrol(saturation.empty_panel, ...
        'Style','text',...
        'units','normalized',...
        'Position',[0.01 0.7 0.13 0.4], ...
        'String','min', ...
        'FontSize', 12,...
        'horizontal','left');
    
    saturation.empty_max = uicontrol(saturation.empty_panel, ...
        'Style','text',...
        'units','normalized',...
        'Position',[0.86 0.7 0.13 0.4],...
        'String','max',...
        'FontSize', 12,...
        'horizontal','right');
    
    saturation.h_checkBox = uicontrol(h_panel3,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.75 0.99 0.04],...
        'string','Slider5', ...
        'value',0,...
        'tag','checkBox5',...
        'CallBack',{@slider_checkbox_callback,saturation},...
        'fontsize',10);
    
    %----------------------------------------------------------------------
    %  Slider 6
    
    % create userdata struct
    userdata.isRandom = 'no';
    userdata.flowControl = 'off';
    %userdata.stopMessage = 'Et arvioinut jotain';
    userdata.stopMessage = 'You did not evaluated something';
    userdata.isTouched = 'false';
    userdata.question = 'Slider6';
    userdata.isPlotting = 'false';
    
    slider6.empty_panel = uipanel(h_panel2,...
        'units','normalized',...
        'Position',[0.01 0.3 0.98 0.1],...
        'visible','off',...
        'tag','slider_panel6',...
        'userdata',userdata,...
        'title','Slider6',...
        'fontsize',14,...
        'titleposition','centertop');
    
    slider6.empty_min = uicontrol(slider6.empty_panel, 'Style','text',...
        'units','normalized',...
        'Position',[0.01 0.7 0.13 0.4], ...
        'String','min', ...
        'FontSize', 12, ...
        'tag','slider_min6',...
        'horizontal','left');
    
    slider6.empty_max = uicontrol(slider6.empty_panel, 'Style','text',...
        'units','normalized',...
        'Position',[0.86 0.7 0.13 0.4],...
        'String','max',...
        'FontSize', 12, ...
        'tag','slider_max6',...
        'horizontal','right');
    
    slider6.h_slider = uicontrol(slider6.empty_panel, ...
        'style','slider',...
        'units','normalized',...
        'position',[0.01 0.05 0.98 0.6], ...
        'tag','slider6',...
        'sliderstep',[.5 .01],...
        'max',100,...
        'min',0,...
        'value',100,...
        'CallBack',@slider_callback,...
        'BackgroundColor', [0.9 0.9 0.9],...
        'userdata',userdata,...
        'enable','off');
    
    slider6.h_checkBox = uicontrol(h_panel3,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.70 0.99 0.04],...
        'value',0,...
        'tag','slidercheckBox6',...
        'CallBack',{@slider_checkbox_callback,slider6}, ...
        'fontsize',10,...
        'string','Slider6');
    
    %----------------------------------------------------------------------
    %  Slider 7
    
    % create userdata struct
    userdata.isRandom = 'no';
    userdata.flowControl = 'off';
    %userdata.stopMessage = 'Et arvioinut jotain';
    userdata.stopMessage = 'You did not evaluated something';
    userdata.isTouched = 'false';
    userdata.question = 'Slider7';
    userdata.isPlotting = 'false';
    
    slider7.empty_panel = uipanel(h_panel2,...
        'units','normalized',...
        'Position',[0.01 0.3 0.98 0.1],...
        'visible','off',...
        'tag','slider_panel7',...
        'userdata',userdata,...
        'title','Slider7',...
        'fontsize',14,...
        'titleposition','centertop');
    
    slider7.empty_min = uicontrol(slider7.empty_panel, 'Style','text',...
        'units','normalized',...
        'Position',[0.01 0.7 0.13 0.4], ...
        'String','min', ...
        'FontSize', 12, ...
        'tag','slider_min7',...
        'horizontal','left');
    
    slider7.empty_max = uicontrol(slider7.empty_panel, 'Style','text',...
        'units','normalized',...
        'Position',[0.86 0.7 0.13 0.4],...
        'String','max',...
        'FontSize', 12, ...
        'tag','slider_max7',...
        'horizontal','right');
    
    slider7.h_slider = uicontrol(slider7.empty_panel, ...
        'style','slider',...
        'units','normalized',...
        'position',[0.01 0.05 0.98 0.6], ...
        'tag','slider7',...
        'sliderstep',[.5 .01],...
        'max',100,...
        'min',0,...
        'value',100,...
        'CallBack',@slider_callback,...
        'BackgroundColor', [0.9 0.9 0.9],...
        'userdata',userdata,...
        'enable','off');
    
    slider7.h_checkBox = uicontrol(h_panel3,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.65 0.99 0.04],...
        'value',0,...
        'tag','slidercheckBox7',...
        'CallBack',{@slider_checkbox_callback,slider7}, ...
        'fontsize',10,...
        'string','Slider7');
    
    %----------------------------------------------------------------------
    %  Slider 8
    
    % create userdata struct
    userdata.isRandom = 'no';
    userdata.flowControl = 'off';
    %userdata.stopMessage = 'Et arvioinut jotain';
    userdata.stopMessage = 'You did not evaluated something';
    userdata.isTouched = 'false';
    userdata.question = 'Slider8';
    userdata.isPlotting = 'false';
    
    slider8.empty_panel = uipanel(h_panel2,...
        'units','normalized',...
        'Position',[0.01 0.3 0.98 0.1],...
        'visible','off',...
        'tag','slider_panel7',...
        'userdata',userdata,...
        'title','Slider8',...
        'fontsize',14,...
        'titleposition','centertop');
    
    slider8.empty_min = uicontrol(slider8.empty_panel, 'Style','text',...
        'units','normalized',...
        'Position',[0.01 0.7 0.13 0.4], ...
        'String','min', ...
        'FontSize', 12, ...
        'tag','slider_min8',...
        'horizontal','left');
    
    slider8.empty_max = uicontrol(slider8.empty_panel, 'Style','text',...
        'units','normalized',...
        'Position',[0.86 0.7 0.13 0.4],...
        'String','max',...
        'FontSize', 12, ...
        'tag','slider_max8',...
        'horizontal','right');
    
    slider8.h_slider = uicontrol(slider8.empty_panel, ...
        'style','slider',...
        'units','normalized',...
        'position',[0.01 0.05 0.98 0.6], ...
        'tag','slider8',...
        'sliderstep',[.5 .01],...
        'max',100,...
        'min',0,...
        'value',100,...
        'CallBack',@slider_callback,...
        'BackgroundColor', [0.9 0.9 0.9],...
        'userdata',userdata,...
        'enable','off');
    
    slider8.h_checkBox = uicontrol(h_panel3,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.60 0.99 0.04],...
        'value',0,...
        'tag','slidercheckBox8',...
        'CallBack',{@slider_checkbox_callback,slider8}, ...
        'fontsize',10,...
        'string','Slider8');
    
    %----------------------------------------------------------------------
    %  Slider 9
    
    % create userdata struct
    userdata.isRandom = 'no';
    userdata.flowControl = 'off';
    %userdata.stopMessage = 'Et arvioinut jotain';
    userdata.stopMessage = 'You did not evaluated something';
    userdata.isTouched = 'false';
    userdata.question = 'Slider9';
    userdata.isPlotting = 'false';
    
    slider9.empty_panel = uipanel(h_panel2,...
        'units','normalized',...
        'Position',[0.01 0.3 0.98 0.1],...
        'visible','off',...
        'tag','slider_panel9',...
        'userdata',userdata,...
        'title','Slider9',...
        'fontsize',14,...
        'titleposition','centertop');
    
    slider9.empty_min = uicontrol(slider9.empty_panel, 'Style','text',...
        'units','normalized',...
        'Position',[0.01 0.7 0.13 0.4], ...
        'String','min', ...
        'FontSize', 12, ...
        'tag','slider_min9',...
        'horizontal','left');
    
    slider9.empty_max = uicontrol(slider9.empty_panel, 'Style','text',...
        'units','normalized',...
        'Position',[0.86 0.7 0.13 0.4],...
        'String','max',...
        'FontSize', 12, ...
        'tag','slider_max9',...
        'horizontal','right');
    
    slider9.h_slider = uicontrol(slider9.empty_panel, ...
        'style','slider',...
        'units','normalized',...
        'position',[0.01 0.05 0.98 0.6], ...
        'tag','slider9',...
        'sliderstep',[.5 .01],...
        'max',100,...
        'min',0,...
        'value',100,...
        'CallBack',@slider_callback,...
        'BackgroundColor', [0.9 0.9 0.9],...
        'userdata',userdata,...
        'enable','off');
    
    slider9.h_checkBox = uicontrol(h_panel3,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.55 0.99 0.04],...
        'value',0,...
        'tag','slidercheckBox9',...
        'CallBack',{@slider_checkbox_callback,slider9}, ...
        'fontsize',10,...
        'string','Slider9');
    
    %----------------------------------------------------------------------
    %  Slider 10
    
    % create userdata struct
    userdata.isRandom = 'no';
    userdata.flowControl = 'off';
    %userdata.stopMessage = 'Et arvioinut jotain';
    userdata.stopMessage = 'You did not evaluated something';
    userdata.isTouched = 'false';
    userdata.question = 'Slider10';
    userdata.isPlotting = 'false';
    
    slider10.empty_panel = uipanel(h_panel2,...
        'units','normalized',...
        'Position',[0.01 0.3 0.98 0.1],...
        'visible','off',...
        'tag','slider_panel10',...
        'userdata',userdata,...
        'title','Slider10',...
        'fontsize',14,...
        'titleposition','centertop');
    
    slider10.empty_min = uicontrol(slider10.empty_panel, 'Style','text',...
        'units','normalized',...
        'Position',[0.01 0.7 0.13 0.4], ...
        'String','min', ...
        'FontSize', 12, ...
        'tag','slider_min10',...
        'horizontal','left');
    
    slider10.empty_max = uicontrol(slider10.empty_panel, 'Style','text',...
        'units','normalized',...
        'Position',[0.86 0.7 0.13 0.4],...
        'String','max',...
        'FontSize', 12, ...
        'tag','slider_max10',...
        'horizontal','right');
    
    slider10.h_slider = uicontrol(slider10.empty_panel, ...
        'style','slider',...
        'units','normalized',...
        'position',[0.01 0.05 0.98 0.6], ...
        'tag','slider10',...
        'sliderstep',[.5 .01],...
        'max',100,...
        'min',0,...
        'value',100,...
        'CallBack',@slider_callback,...
        'BackgroundColor', [0.9 0.9 0.9],...
        'userdata',userdata,...
        'enable','off');
    
    slider10.h_checkBox = uicontrol(h_panel3,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.50 0.99 0.04],...
        'value',0,...
        'tag','slidercheckBox10',...
        'CallBack',{@slider_checkbox_callback,slider10}, ...
        'fontsize',10,...
        'string','Slider10');
    
    %----------------------------------------------------------------------
    %  Content related slider
    
    % create userdata struct
    userdata.isRandom = 'no';
    userdata.flowControl = 'off';
    %userdata.stopMessage = 'Et arvioinut jotain';
    userdata.stopMessage = 'You did not evaluated something';
    userdata.isTouched = 'false';
    userdata.question = 'contentrelatedslider';
    userdata.isPlotting = 'false';
    userdata.contentRelatedQuestions = 'false';
    
    empty1.empty_panel = uipanel(h_panel2,...
        'units','normalized',...
        'Position',[0.01 0.4 0.98 0.1],...
        'visible','off',...
        'tag','empty_panel1',...
        'userdata',userdata,...
        'title','Content related slider',...
        'fontsize',14,...
        'titleposition','centertop');
    
    empty1.empty_min = uicontrol(empty1.empty_panel, 'Style','text',...
        'units','normalized',...
        'Position',[0.01 0.7 0.13 0.4], ...
        'String','min', ...
        'FontSize', 12, ...
        'tag','empty_min1',...
        'horizontal','left');
    
    empty1.empty_max = uicontrol(empty1.empty_panel, 'Style','text',...
        'units','normalized',...
        'Position',[0.86 0.7 0.13 0.4],...
        'String','max',...
        'FontSize', 12, ...
        'tag','empty_max1',...
        'horizontal','right');
    
    empty1.h_slider = uicontrol(empty1.empty_panel, ...
        'style','slider',...
        'units','normalized',...
        'position',[0.01 0.05 0.98 0.6], ...
        'tag','slider12',...
        'sliderstep',[.5 .01],...
        'max',100,...
        'min',0,...
        'value', 100,...
        'CallBack',@slider_callback,...
        'BackgroundColor', [0.9 0.9 0.9],...
        'userdata',userdata,...
        'enable','off');
    
    empty1.h_checkBox = uicontrol(h_panel3,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.35 0.99 0.04],...
        'value',0,...
        'tag','checkBox6',...
        'string','Content related slider',...
        'CallBack',{@slider_checkbox_callback,empty1}, ...
        'fontsize',10);
    
    clear userdata
    %----------------------------------------------------------------------
    % Slider 11
    
    % create userdata struct
    userdata.isRandom = 'no';
    userdata.flowControl = 'off';
    %userdata.stopMessage = 'Et arvioinut jotain';
    userdata.stopMessage = 'You did not evaluated something';
    userdata.isTouched = 'false';
    userdata.question = 'Slider11';
    userdata.isPlotting = 'false';
    
    slider11.empty_panel = uipanel(h_panel2,...
        'units','normalized',...
        'Position',[0.01 0.3 0.98 0.1],...
        'visible','off',...
        'tag','empty_panel11',...
        'userdata',userdata,...
        'title','Slider11',...
        'fontsize',14,...
        'titleposition','centertop');
    
    slider11.empty_min = uicontrol(slider11.empty_panel, 'Style','text',...
        'units','normalized',...
        'Position',[0.01 0.7 0.13 0.4], ...
        'String','min', ...
        'FontSize', 12, ...
        'tag','empty_min11',...
        'horizontal','left');
    
    slider11.empty_max = uicontrol(slider11.empty_panel, 'Style','text',...
        'units','normalized',...
        'Position',[0.86 0.7 0.13 0.4],...
        'String','max',...
        'FontSize', 12, ...
        'tag','empty_max11',...
        'horizontal','right');
    
    slider11.h_slider = uicontrol(slider11.empty_panel, ...
        'style','slider',...
        'units','normalized',...
        'position',[0.01 0.05 0.98 0.6], ...
        'tag','slider11',...
        'sliderstep',[.5 .01],...
        'max',100,...
        'min',0,...
        'value',100,...
        'CallBack',@slider_callback,...
        'BackgroundColor', [0.9 0.9 0.9],...
        'userdata',userdata,...
        'enable','off');
    
    slider11.h_checkBox = uicontrol(h_panel3,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.45 0.99 0.04],...
        'value',0,...
        'tag','slidercheckBox11',...
        'CallBack',{@slider_checkbox_callback,slider11}, ...
        'fontsize',10,...
        'string','Slider11');
    
    %----------------------------------------------------------------------
    %  Triplet slider group------------------------------------------------
    
    % create userdata struct
    userdata.isRandom = 'no';
    userdata.flowControl = 'off';
    %userdata.stopMessage = 'Kuvat eiv‰t saa olla yht‰ hyvi‰.';
    userdata.stopMessage = 'The images can not be equally good';
    userdata.isTouched = 'false';
    userdata.question = 'Laitakuvatparemmuusjarjestykseen';
    
    triplet.h_checkBox = uicontrol(h_panel8,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.82 0.99 0.04],...
        'value',0,...
        'tag','tripletCheckBox',...
        'string','Triplet slider group',...
        'CallBack','QBU(''tripletCheckBox'');', ...
        'fontsize',10);
    
    triplet.empty_panel = uipanel(h_panel2,...
        'units','normalized',...
        'Position',[0.01 0.3 0.98 0.7],...
        'visible','off',...
        'tag','triplet_panel',...
        'title','Rank the images',...
        'fontsize',14,...
        'titleposition','centertop',...
        'userdata',userdata);
    
    userdata.question = 'vasen';
    triplet.h_slider1 = uicontrol(triplet.empty_panel, ...
        'style','slider',...
        'units','normalized',...
        'position',[0.1 0.1 0.2 0.8], ...
        'tag','triplet_slider1',...
        'sliderstep',[1/2 1/2],...
        'max',3,...
        'min',1,...
        'value', 1,...
        'CallBack',@triplet_slider1,...
        'BackgroundColor', [0.9 0.9 0.9],...
        'userdata',userdata);
    
    userdata.question = 'keskimmainen';
    triplet.h_slider2 = uicontrol(triplet.empty_panel, ...
        'style','slider',...
        'units','normalized',...
        'position',[0.41 0.1 0.2 0.8], ...
        'tag','triplet_slider2',...
        'sliderstep',[1/2 1/2],...
        'max',3,...
        'min',1,...
        'value', 1,...
        'CallBack',@triplet_slider2,...
        'BackgroundColor', [0.9 0.9 0.9],...
        'userdata',userdata);
    
    userdata.question = 'oikea';
    triplet.h_slider3 = uicontrol(triplet.empty_panel, ...
        'style','slider',...
        'units','normalized',...
        'position',[0.71 0.1 0.2 0.8], ...
        'tag','triplet_slider3',...
        'sliderstep',[1/2 1/2],...
        'max',3,...
        'min',1,...
        'value', 1,...
        'CallBack',@triplet_slider3,...
        'BackgroundColor', [0.9 0.9 0.9],...
        'userdata',userdata);
    
    uicontrol(triplet.empty_panel, ...
        'Style','text',...
        'units','normalized',...
        'Position',[0.16 0.9 0.07 0.04], ...
        'String','Best', ...
        'FontSize', 12);
    
    uicontrol(triplet.empty_panel, ...
        'Style','text',...
        'units','normalized',...
        'Position',[0.47 0.9 0.07 0.04], ...
        'String','Best', ...
        'FontSize', 12);
    
    uicontrol(triplet.empty_panel, ...
        'Style','text',...
        'units','normalized',...
        'Position',[0.77 0.9 0.07 0.04], ...
        'String','Best', ...
        'FontSize', 12);
    
    uicontrol(triplet.empty_panel, ...
        'Style','text',...
        'units','normalized',...
        'Position',[0.16 0.05 0.07 0.04], ...
        'String','Worst', ...
        'FontSize', 12);
    
    uicontrol(triplet.empty_panel, ...
        'Style','text',...
        'units','normalized',...
        'Position',[0.47 0.05 0.07 0.04], ...
        'String','Worst', ...
        'FontSize', 12);
    
    uicontrol(triplet.empty_panel, ...
        'Style','text',...
        'units','normalized',...
        'Position',[0.77 0.05 0.07 0.04], ...
        'String','Worst', ...
        'FontSize', 12);
    
    uicontrol(h_panel8, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.82 0.6 0.04],...
        'CallBack',{@triplet_props,triplet},...
        'tag','triplet_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    %----------------------------------------------------------------------
    %  Continuous measurement slider---------------------------------------
    % create userdata struct
    userdata.isRandom = 'no';
    userdata.flowControl = 'off';
    userdata.stopMessage = 'Et koskenut liukus‰‰timeen.';
    userdata.isTouched = 'false';
    userdata.question = 'Arvioikuvanlaatua';
    userdata.isContinuous = 'false';
    userdata.scroll_step = 1;
    
    continuous.h_checkBox = uicontrol(h_panel8,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.92 0.99 0.04],...
        'value',0,...
        'tag','continuousCheckBox',...
        'string','Continuous measurement slider',...
        'CallBack','QBU(''continuousCheckBox'');', ...
        'fontsize',10);
    
    continuous.empty_panel = uipanel(h_panel2,...
        'units','normalized',...
        'Position',[0.4 0.1 0.2 0.88],...
        'visible','off',...
        'tag','continuous_panel',...
        'title','Evaluate image quality',...
        'fontsize',14,...
        'titleposition','centertop',...
        'userdata',userdata);
    
    continuous.empty_min = uicontrol(continuous.empty_panel, 'Style','text',...
        'units','normalized',...
        'Position',[0 0.009 0.99 0.05], ...
        'String','Bad', ...
        'FontSize', 12, ...
        'tag','continuous_min',...
        'horizontalalign','center');
    
    continuous.empty_max = uicontrol(continuous.empty_panel, 'Style','text',...
        'units','normalized',...
        'Position',[0 0.92 0.99 0.05],...
        'String','Excellent',...
        'FontSize', 12, ...
        'tag','continuous_max');
    
    continuous.h_slider = uicontrol(continuous.empty_panel, ...
        'style','slider',...
        'units','normalized',...
        'position',[0.05 0.08 0.9 0.85], ...
        'tag','continuous_slider',...
        'sliderstep',[.5 .01],...
        'max',100,...
        'min',0,...
        'value', 0,...
        'CallBack',@continuous_slider,...
        'BackgroundColor', [0.9 0.9 0.9],...
        'userdata',userdata,...
        'tag','continuous_slider');
    
    uicontrol(h_panel8, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.59 0.92 0.4 0.04],...
        'CallBack',{@continuous_props,continuous},...
        'tag','continuous_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    %----------------------------------------------------------------------
    %  Push buttons
    
    if strcmp(setup.standard,'Video SSCQE') == 0 || setup.extra_questions ~= 1
        % Continue button
        uicontrol(h_panel2, 'style','pushbutton', ...
            'Units', 'Normalized', ...
            'position',[0.69 0.01 0.3 0.07],...
            'CallBack',@continue_button,...
            'tag','continue_button', ...
            'string','Next image',...
            'FontSize', 14,...
            'enable','off');
    end
    
    uicontrol(h_panel1, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.5 0.01 0.48 0.04],...
        'CallBack','QBU(''save'');',...
        'tag','saveButton', ...
        'string','Save and exit',...
        'FontSize', 12,...
        'back','green');
    
    uicontrol(h_panel1, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.02 0.01 0.48 0.04],...
        'CallBack','QBU(''go_back'');',...
        'tag','backButton', ...
        'string','Previous screen',...
        'FontSize', 12);
    
    uicontrol(h_panel3, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.35 0.6 0.04],...
        'CallBack',{@slider_props,empty1},...
        'tag','empty1_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    uicontrol(h_panel3, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.45 0.6 0.04],...
        'CallBack',{@slider_props,slider11},...
        'tag','slider11_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    uicontrol(h_panel3, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.95 0.6 0.04],...
        'CallBack',{@overall_props,overall},...
        'tag','overall_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    uicontrol(h_panel3, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.90 0.6 0.04],...
        'CallBack',{@focus_props,focus},...
        'tag','focus_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    uicontrol(h_panel3, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.85 0.6 0.04],...
        'CallBack',{@graininess_props,graininess},...
        'tag','graininess_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    uicontrol(h_panel3, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.80 0.6 0.04],...
        'CallBack',{@lightness_props,lightness},...
        'tag','lightness_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    uicontrol(h_panel3, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.75 0.6 0.04],...
        'CallBack',{@saturation_props,saturation},...
        'tag','saturation_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    uicontrol(h_panel3, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.70 0.6 0.04],...
        'CallBack',{@slider_props,slider6},...
        'tag','saturation_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    uicontrol(h_panel3, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.65 0.6 0.04],...
        'CallBack',{@slider_props,slider7},...
        'tag','saturation_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    uicontrol(h_panel3, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.60 0.6 0.04],...
        'CallBack',{@slider_props,slider8},...
        'tag','saturation_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    uicontrol(h_panel3, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.55 0.6 0.04],...
        'CallBack',{@slider_props,slider9},...
        'tag','saturation_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    uicontrol(h_panel3, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.50 0.6 0.04],...
        'CallBack',{@slider_props,slider10},...
        'tag','saturation_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    % Clear userdata for next component type
    clear userdata
    %----------------------------------------------------------------------
    % Multiple choice selections
    
    % popup 1
    uicontrol(h_panel6,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.92 0.6 0.04], ...
        'string','Popup 1', ...
        'value',0,...
        'tag','checkBox8',...
        'CallBack','QBU(''checkBox8'');',...
        'fontsize',10);
    
    % Create struct for userdata
    userdata.question = 'question1';
    userdata.flowControl = 'off';
    userdata.stopMessage = 'Et koskenut monivalintaan';
    userdata.isTouched = 'false';
    
    popups.popup1 = uicontrol(h_panel2,...
        'Style','popupmenu', ...
        'units', 'normalized', ...
        'String',{'question 1','string1','string2','string3','string4'},...
        'Value',1, ...
        'Position',[0.55 0.1 0.4 0.1],...
        'CallBack',{@popup1_sel},...
        'visible','off',...
        'tag','popup1',...
        'userdata',userdata,...
        'fontsize',12);
    
    uicontrol(h_panel6, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.92 0.6 0.04],...
        'CallBack',{@popup_props,popups.popup1},...
        'tag','popup1_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    % popup 2
    
    % Create struct for userdata
    userdata.question = 'question2';
    userdata.flowControl = 'off';
    userdata.stopMessage = 'Et koskenut monivalintaan';
    userdata.isTouched = 'false';
    
    uicontrol(h_panel6,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.82 0.99 0.04], ...
        'string','Popup 2', ...
        'value',0,...
        'tag','checkBox9',...
        'CallBack','QBU(''checkBox9'');',...
        'fontsize',10);
    
    popups.popup2 = uicontrol(h_panel2,...
        'Style','popupmenu', ...
        'units', 'normalized', ...
        'String',{'question 2','string1','string2','string3','string4'},...
        'Value',1, ...
        'Position',[0.55 0.06 0.4 0.1],...
        'CallBack',{@popup2_sel},...
        'visible','off',...
        'tag','popup2',...
        'userdata',userdata,...
        'fontsize',12);
    
    uicontrol(h_panel6, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.82 0.6 0.04],...
        'CallBack',{@popup_props,popups.popup2},...
        'tag','popup2_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    % popup 3
    
    % Create struct for userdata
    userdata.question = 'question3';
    userdata.flowControl = 'off';
    userdata.stopMessage = 'Et koskenut monivalintaan';
    userdata.isTouched = 'false';
    
    uicontrol(h_panel6,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.72 0.99 0.04], ...
        'string','Popup 3', ...
        'value',0,...
        'tag','checkBox10',...
        'CallBack','QBU(''checkBox10'');',...
        'fontsize',10);
    
    popups.popup3 = uicontrol(h_panel2,...
        'Style','popupmenu', ...
        'units', 'normalized', ...
        'String',{'question 3','string1','string2','string3','string4'},...
        'Value',1, ...
        'Position',[0.55 0.02 0.4 0.1],...
        'CallBack',{@popup3_sel},...
        'visible','off',...
        'tag','popup3',...
        'userdata',userdata,...
        'fontsize',12);
    
    uicontrol(h_panel6, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.72 0.6 0.04],...
        'CallBack',{@popup_props,popups.popup3},...
        'tag','popup3_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    clear userdata
    %%% Open Questions
    %----------------------------------------------------------------------
    % Question 1
    
    % Create struct for userdata
    userdata.question = 'Question1';
    userdata.flowControl = 'off';
    userdata.isTouched = 'false';
    
    uicontrol(h_panel5,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.92 0.9 0.04], ...
        'string','Question 1', ...
        'value',0,...
        'tag','checkBox11',...
        'CallBack','QBU(''checkBox11'');',...
        'fontsize',10);
    
    open.question_panel1 = uipanel(h_panel2,...
        'units','normalized', ...
        'Position',[0.001 0.08 0.5 0.1], ...
        'title','Question 1', ...
        'FontSize', 12,...
        'visible','off',...
        'tag','open1',...
        'userdata',userdata);
    
    open.question_box1 = uicontrol(open.question_panel1, 'Style','edit', ...
        'units','normalized', ...
        'Position',[0.02 0.08 0.96 0.97], ...
        'CallBack',{@open_question1,open.question_panel1},...
        'tag','question_box1', ...
        'HorizontalAlignment', 'left',...
        'BackgroundColor', 'w',...
        'max',1,...
        'fontsize',12);
    
    % Pushbutton for prop editor
    uicontrol(h_panel5, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.92 0.6 0.04],...
        'CallBack',{@open_props,open.question_panel1},...
        'tag','open_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    % Question 2
    %----------------------------------------------------------------------
    % Create struct for userdata
    userdata.question = 'Question2';
    userdata.flowControl = 'off';
    userdata.isTouched = 'false';
    
    uicontrol(h_panel5,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.82 0.9 0.04], ...
        'string','Question 2', ...
        'value',0,...
        'tag','checkBox12',...
        'CallBack','QBU(''checkBox12'');',...
        'fontsize',10);
    
    open.question_panel2 = uipanel(h_panel2,...
        'units','normalized', ...
        'Position',[0.001 0.18 0.5 0.1], ...
        'title','Question 2', ...
        'FontSize', 12,...
        'visible','off',...
        'tag','open2',...
        'userdata',userdata);
    
    open.question_box2 = uicontrol(open.question_panel2, 'Style','edit', ...
        'units','normalized', ...
        'Position',[0.02 0.08 0.96 0.97], ...
        'CallBack',{@open_question2,open.question_panel2},...
        'tag','question_box2', ...
        'HorizontalAlignment', 'left',...
        'BackgroundColor', 'w',...
        'max',1,...
        'fontsize',12);
    
    % Pushbutton for prop editor
    uicontrol(h_panel5, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.82 0.6 0.04],...
        'CallBack',{@open_props,open.question_panel2},...
        'tag','open_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    % Question 3
    %----------------------------------------------------------------------
    % Create struct for userdata
    userdata.question = 'Question3';
    userdata.flowControl = 'off';
    userdata.isTouched = 'false';
    
    uicontrol(h_panel5,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.72 0.9 0.04], ...
        'string','Question 3', ...
        'value',0,...
        'tag','checkBox13',...
        'CallBack','QBU(''checkBox13'');',...
        'fontsize',10);
    
    open.question_panel3 = uipanel(h_panel2,...
        'units','normalized', ...
        'Position',[0.5 0.08 0.5 0.1], ...
        'title','Question 3', ...
        'FontSize', 12,...
        'visible','off',...
        'tag','open3',...
        'userdata',userdata);
    
    open.question_box3 = uicontrol(open.question_panel3, 'Style','edit', ...
        'units','normalized', ...
        'Position',[0.02 0.08 0.96 0.97], ...
        'CallBack',{@open_question3,open.question_panel3},...
        'tag','question_box3', ...
        'HorizontalAlignment', 'left',...
        'BackgroundColor', 'w',...
        'max',1,...
        'fontsize',12);
    
    % Pushbutton for prop editor
    uicontrol(h_panel5, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.72 0.6 0.04],...
        'CallBack',{@open_props,open.question_panel3},...
        'tag','open_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    % Question 4
    %----------------------------------------------------------------------
    % Create struct for userdata
    userdata.question = 'Question4';
    userdata.flowControl = 'off';
    userdata.isTouched = 'false';
    
    uicontrol(h_panel5,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.62 0.3 0.04], ...
        'string','Question 4', ...
        'value',0,...
        'tag','checkBox14',...
        'CallBack','QBU(''checkBox14'');',...
        'fontsize',10);
    
    open.question_panel4 = uipanel(h_panel2,...
        'units','normalized', ...
        'Position',[0.5 0.18 0.5 0.1], ...
        'title','Question 4', ...
        'FontSize', 12,...
        'visible','off',...
        'tag','open4',...
        'userdata',userdata);
    
    open.question_box4 = uicontrol(open.question_panel4, 'Style','edit', ...
        'units','normalized', ...
        'Position',[0.02 0.08 0.96 0.97], ...
        'CallBack',{@open_question4,open.question_panel4},...
        'tag','question_box4', ...
        'HorizontalAlignment', 'left',...
        'BackgroundColor', 'w',...
        'max',1,...
        'fontsize',12);
    
    % Pushbutton for prop editor
    uicontrol(h_panel5, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.62 0.6 0.04],...
        'CallBack',{@open_props,open.question_panel4},...
        'tag','open_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    % Question 5
    %----------------------------------------------------------------------
    
    %     uicontrol(h_panel5,'style','checkbox',...
    %         'units','normalized', ...
    %         'position',[0.01 0.52 0.9 0.04], ...
    %         'string','Select general textbox 2', ...
    %         'value',0,...
    %         'tag','checkBox15',...
    %         'CallBack','QBU(''checkBox15'');',...
    %         'fontsize',10);
    
    clear userdata
    
    %%% Checkboxes %%%-----------------------------------------------------
    %
    % Checkbox 1
    %----------------------------------------------------------------------
    % Create struct for userdata
    userdata.question = 'Checkbox1';
    userdata.flowControl = 'off';
    userdata.isTouched = 'false';
    
    uicontrol(h_panel4,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.92 0.3 0.04], ...
        'string','Checkbox 1', ...
        'value',0,...
        'tag','checkBox16',...
        'CallBack','QBU(''checkBox16'');',...
        'fontsize',10);
    
    boxes.box1 = uicontrol(h_panel2,'style','checkbox',...
        'units','normalized', ...
        'position',[0.5 0.27 0.3 0.03], ...
        'string','Checkbox 1', ...
        'value',0,...
        'tag','checkBox22',...
        'CallBack',@checkboxes,...
        'fontsize',12, ...
        'BackgroundColor', [0.85 0.85 0.85],...
        'visible','off',...
        'userdata',userdata);
    
    % Pushbutton for prop editor
    uicontrol(h_panel4, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.92 0.6 0.04],...
        'CallBack',{@box_props,boxes.box1},...
        'tag','box_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    % Checkbox 2
    %----------------------------------------------------------------------
    % Create struct for userdata
    userdata.question = 'Checkbox2';
    userdata.flowControl = 'off';
    userdata.isTouched = 'false';
    
    uicontrol(h_panel4,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.82 0.3 0.04], ...
        'string','Checkbox 2', ...
        'value',0,...
        'tag','checkBox17',...
        'CallBack','QBU(''checkBox17'');',...
        'fontsize',10);
    
    boxes.box2 = uicontrol(h_panel2,'style','checkbox',...
        'units','normalized', ...
        'position',[0.5 0.24 0.3 0.03], ...
        'string','Checkbox 2', ...
        'value',0,...
        'tag','checkBox23',...
        'CallBack',@checkboxes,...
        'fontsize',12, ...
        'BackgroundColor', [0.85 0.85 0.85],...
        'visible','off',...
        'userdata',userdata);
    
    % Pushbutton for prop editor
    uicontrol(h_panel4, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.82 0.6 0.04],...
        'CallBack',{@box_props,boxes.box2},...
        'tag','box_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    % Checkbox 3
    %----------------------------------------------------------------------
    % Create struct for userdata
    userdata.question = 'Checkbox3';
    userdata.flowControl = 'off';
    userdata.isTouched = 'false';
    
    uicontrol(h_panel4,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.72 0.3 0.04], ...
        'string','Checkbox 3', ...
        'value',0,...
        'tag','checkBox18',...
        'CallBack','QBU(''checkBox18'');',...
        'fontsize',10);
    
    boxes.box3 = uicontrol(h_panel2,'style','checkbox',...
        'units','normalized', ...
        'position',[0.5 0.21 0.3 0.03], ...
        'string','Checkbox 3', ...
        'value',0,...
        'tag','checkBox24',...
        'CallBack',@checkboxes,...
        'fontsize',12, ...
        'BackgroundColor', [0.85 0.85 0.85],...
        'visible','off',...
        'userdata',userdata);
    
    % Pushbutton for prop editor
    uicontrol(h_panel4, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.72 0.6 0.04],...
        'CallBack',{@box_props,boxes.box3},...
        'tag','box_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    % Checkbox 4
    %----------------------------------------------------------------------
    % Create struct for userdata
    userdata.question = 'Checkbox4';
    userdata.flowControl = 'off';
    userdata.isTouched = 'false';
    
    uicontrol(h_panel4,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.62 0.3 0.04], ...
        'string','Checkbox 4', ...
        'value',0,...
        'tag','checkBox19',...
        'CallBack','QBU(''checkBox19'');',...
        'fontsize',10);
    
    boxes.box4 = uicontrol(h_panel2,'style','checkbox',...
        'units','normalized', ...
        'position',[0.5 0.18 0.3 0.03], ...
        'string','Checkbox 4', ...
        'value',0,...
        'tag','checkBox25',...
        'CallBack',@checkboxes,...
        'fontsize',12, ...
        'BackgroundColor', [0.85 0.85 0.85],...
        'visible','off',...
        'userdata',userdata);
    
    % Pushbutton for prop editor
    uicontrol(h_panel4, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.62 0.6 0.04],...
        'CallBack',{@box_props,boxes.box4},...
        'tag','box_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    % Checkbox 5
    %----------------------------------------------------------------------
    % Create struct for userdata
    userdata.question = 'Checkbox5';
    userdata.flowControl = 'off';
    userdata.isTouched = 'false';
    
    uicontrol(h_panel4,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.52 0.3 0.04], ...
        'string','Checkbox 5', ...
        'value',0,...
        'tag','checkBox20',...
        'CallBack','QBU(''checkBox20'');',...
        'fontsize',10);
    
    boxes.box5 = uicontrol(h_panel2,'style','checkbox',...
        'units','normalized', ...
        'position',[0.5 0.15 0.3 0.03], ...
        'string','Checkbox 5', ...
        'value',0,...
        'tag','checkBox26',...
        'CallBack',@checkboxes,...
        'fontsize',12, ...
        'BackgroundColor', [0.85 0.85 0.85],...
        'visible','off',...
        'userdata',userdata);
    
    % Pushbutton for prop editor
    uicontrol(h_panel4, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.52 0.6 0.04],...
        'CallBack',{@box_props,boxes.box5},...
        'tag','box_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    % Checkbox 6
    %----------------------------------------------------------------------
    % Create struct for userdata
    userdata.question = 'Checkbox6';
    userdata.flowControl = 'off';
    userdata.isTouched = 'false';
    
    uicontrol(h_panel4,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.42 0.3 0.04], ...
        'string','Checkbox 6', ...
        'value',0,...
        'tag','checkBox21',...
        'CallBack','QBU(''checkBox21'');',...
        'fontsize',10);
    
    boxes.box6 = uicontrol(h_panel2,'style','checkbox',...
        'units','normalized', ...
        'position',[0.5 0.12 0.3 0.03], ...
        'string','Checkbox 6', ...
        'value',0,...
        'tag','checkBox27',...
        'CallBack',@checkboxes,...
        'fontsize',12, ...
        'BackgroundColor', [0.85 0.85 0.85],...
        'visible','off',...
        'userdata',userdata);
    
    % Pushbutton for prop editor
    uicontrol(h_panel4, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.42 0.6 0.04],...
        'CallBack',{@box_props,boxes.box6},...
        'tag','box_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    % Radio button pairs---------------------------------------------------
    % Create the set of two Radio buttons.
    
    userdata.question = 'Kumpikuvistaonparempi';
    userdata.flowControl = 'off';
    userdata.isTouched = 'false';
    
    uicontrol(h_panel8,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.72 0.35 0.04], ...
        'string','Radio button pair', ...
        'value',0,...
        'tag','checkBox28',...
        'CallBack','QBU(''checkBox28'');',...
        'fontsize',10);
    
    radio1.panel = uipanel(h_panel2,...
        'units','normalized', ...
        'Position',[0.05 0.5 0.9 0.15], ...
        'title','Select the better image', ...
        'FontSize', 12,...
        'visible','off',...
        'TitlePosition', 'centertop',...
        'tag','radio_panel',...
        'userdata',userdata);
    
    radio1.button(1) = uicontrol(radio1.panel,...
        'style','radio',...
        'units','normalized', ...
        'position',[0.1 0.5 0.3 0.2], ...
        'callback',{@radio_callback,radio1},...
        'tag','button1', ...
        'string','Left image',...
        'fontsize',12,...
        'userdata',userdata);
    
    radio1.button(2) = uicontrol(radio1.panel,...
        'style','radio', ...
        'units','normalized', ...
        'position',[0.75 0.5 0.2 0.2], ...
        'callback',{@radio_callback,radio1},...
        'tag','button2', ...
        'string','Right image',...
        'fontsize',12,...
        'userdata',userdata);
    
    % Pushbutton for prop editor
    uicontrol(h_panel8, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.39 0.72 0.6 0.04],...
        'CallBack',{@radio_props,radio1},...
        'tag','radio_prop_button', ...
        'string','Edit properties',...
        'FontSize', 12);
    
    % Miscellaneous stuff--------------------------------------------------
    
    %----------------------------------------------------------------------
    %Continue button text edit
    uicontrol(h_panel7, ...
        'Style','text', ...
        'Units', 'normalized', ...
        'Position',[.01 .9 .6 .07], ...
        'String','Set text for the continue button:', ...
        'horizontalalign','left',...
        'FontSize', 12);
    
    uicontrol(h_panel7, ...
        'Style','edit', ...
        'Units', 'normalized', ...
        'Position',[.01 .88 .8 .05], ...
        'CallBack',@continue_button_text,...
        'tag','continue_text_box', ...
        'BackgroundColor', 'w',...
        'fontsize',12,...
        'HorizontalAlignment','left');
    
    %----------------------------------------------------------------------
    % Repeat video references button
    uicontrol(h_panel7,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.72 0.99 0.04], ...
        'string','Repeat reference videos -button (Video ACR)', ...
        'value',0,...
        'tag','repeat_ref_checkbox',...
        'CallBack',@repeat_ref_checkbox,...
        'fontsize',12);
    
    uicontrol(h_panel2, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.01 0.01 0.3 0.07],...
        'CallBack',@repeat_ref_button,...
        'tag','repeat_ref_button', ...
        'string','Repeat reference video',...
        'visible','off',...
        'FontSize', 12,...
        'enable','off');
    
    %----------------------------------------------------------------------
    % Repeat dynamic still references button
    uicontrol(h_panel7,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.52 0.99 0.04], ...
        'string','Repeat dynamic ref images -button (Still ACR)', ...
        'value',0,...
        'tag','repeat_dynamic_still_ref_checkbox',...
        'CallBack',@repeat_dynamic_still_ref_checkbox,...
        'fontsize',12);
    
    uicontrol(h_panel2, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.01 0.01 0.3 0.07],...
        'CallBack',@repeat_dynamic_still_ref_button,...
        'tag','repeat_dynamic_still_ref_button', ...
        'string','Repeat reference images',...
        'visible','off',...
        'FontSize', 12,...
        'enable','off');
    
    %----------------------------------------------------------------------
    % Repeat video stimulus button
    uicontrol(h_panel7,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.62 0.99 0.04], ...
        'string','Repeat stimulus -button (Video ACR)', ...
        'value',0,...
        'tag','repeat_stimulus_checkbox',...
        'CallBack',@repeat_stimulus_checkbox,...
        'fontsize',12);
    
    uicontrol(h_panel2, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.32 0.01 0.3 0.07],...
        'CallBack',@repeat_stimulus_button,...
        'tag','repeat_stimulus_button', ...
        'string','Repeat video',...
        'visible','off',...
        'FontSize', 12,...
        'enable','off');
    
    %----------------------------------------------------------------------
    % Repeat PC stimuli -button
    uicontrol(h_panel7,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.42 0.99 0.04], ...
        'string','Repeat stimuli -button (Video/Still PC)', ...
        'value',0,...
        'tag','repeat_pc_stimuli_checkbox',...
        'CallBack',@repeat_pc_stimuli_checkbox,...
        'fontsize',12);
    
    if strcmp(setup.standard,'Still PC')
        label = 'Toista arvioitavat kuvat';
    else
        label = 'Toista arvioitavat videot';
    end
    
    uicontrol(h_panel2, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.01 0.01 0.3 0.07],...
        'CallBack',@repeat_pc_stimuli_button,...
        'tag','repeat_pc_stimuli_button', ...
        'string',label,...
        'visible','off',...
        'FontSize', 12,...
        'enable','off');
    
    %----------------------------------------------------------------------
    % Repeat Video SSCQE stimulus
    uicontrol(h_panel7,'style','checkbox',...
        'units','normalized', ...
        'position',[0.01 0.32 0.99 0.04], ...
        'string','Repeat stimulus -button (Video SSCQE)', ...
        'value',0,...
        'tag','repeat_sscqe_stimulus_checkbox',...
        'CallBack',@repeat_sscqe_stimulus_checkbox,...
        'fontsize',12);
    
    uicontrol(h_panel2, 'style','pushbutton', ...
        'Units', 'Normalized', ...
        'position',[0.32 0.01 0.3 0.07],...
        'CallBack',@repeat_sscqe_stimulus_button,...
        'tag','repeat_sscqe_stimulus_button', ...
        'string','Repeat video',...
        'visible','off',...
        'FontSize', 12,...
        'enable','off');
    
    %----------------------------------------------------------------------
    % Empty panel for subject response plot preview
    uicontrol(h_panel2, ...
        'Style','text', ...
        'Units', 'normalized', ...
        'Position',setup.subject_response_plot_position, ...
        'string',num2cell('Subject response plot panel'), ...
        'horizontalalign','center',...
        'FontSize', 12,...
        'tag','subject_response_plot_position',...
        'background','white',...
        'visible','off');
    
    % Empty panel for continuous subject response plot preview
    uicontrol(h_panel2, ...
        'Style','text', ...
        'Units', 'normalized', ...
        'Position',setup.continuous_subject_response_plot_position, ...
        'string',num2cell('Continuous subject response plot panel'), ...
        'horizontalalign','center',...
        'FontSize', 12,...
        'tag','continuous_subject_response_plot_position',...
        'background','white',...
        'visible','off');
    
    %----------------------------------------------------------------------
    % Extra questions check
    if setup.extra_questions == 1
        h_wdlg = warndlg('Create first the continuous evaluation question window',...
            'Information','replace');
        set(h_wdlg, 'position', [386 400 270 80]);
    elseif setup.extra_questions == 2
        h_wdlg = warndlg('Create next the post stimulus question window',...
            'Information','replace');
        set(h_wdlg, 'position', [386 400 250 80]);
    end
    
    %----------------------------------------------------------------------
    %%% CALLBACKS %%%%%
    %----------------------------------------------------------------------

    % Checkbox for popup 1
elseif(strcmp(command_str,'checkBox8'))
    disp('Popup 1 selected');
    if get(h_checkBox8,'value') == 1
        set(popups.popup1,'visible','on');
    else
        set(popups.popup1,'visible','off');
    end
    
    % Checkbox for popup 2
elseif(strcmp(command_str,'checkBox9'))
    disp('Popup 2 selected');
    if get(h_checkBox9,'value') == 1
        set(popups.popup2,'visible','on');
    else
        set(popups.popup2,'visible','off');
    end
    
    % Checkbox for popup 3
elseif(strcmp(command_str,'checkBox10'))
    disp('Popup 3 selected');
    if get(h_checkBox10,'value') == 1
        set(popups.popup3,'visible','on');
    else
        set(popups.popup3,'visible','off');
    end
    
    %----------------------------------------------------------------------
    
    % Checkbox for open question 1
elseif(strcmp(command_str,'checkBox11'))
    disp('Open question 1 selected');
    if get(h_checkBox11,'value') == 1
        set(open.question_panel1,'visible','on');
    else
        set(open.question_panel1,'visible','off');
    end
    
    % Checkbox for open question 2
elseif(strcmp(command_str,'checkBox12'))
    disp('Open question 2 selected');
    if get(h_checkBox12,'value') == 1
        set(open.question_panel2,'visible','on');
    else
        set(open.question_panel2,'visible','off');
    end
    
    % Checkbox for open question 3
elseif(strcmp(command_str,'checkBox13'))
    disp('Open question 3 selected');
    if get(h_checkBox13,'value') == 1
        set(open.question_panel3,'visible','on');
    else
        set(open.question_panel3,'visible','off');
    end
    
    % Checkbox for open question 4
elseif(strcmp(command_str,'checkBox14'))
    disp('Open question 4 selected');
    if get(h_checkBox14,'value') == 1
        set(open.question_panel4,'visible','on');
    else
        set(open.question_panel4,'visible','off');
    end
    
    % Checkboxes for checkboxes
    %----------------------------------------------------------------------
    % Checkbox for checkbox 1
elseif(strcmp(command_str,'checkBox16'))
    disp('Checkbox 1 selected');
    if get(h_checkBox16,'value') == 1
        set(boxes.box1,'visible','on');
    else
        set(boxes.box1,'visible','off');
    end
    
    % Checkbox for checkbox 2
elseif(strcmp(command_str,'checkBox17'))
    disp('Checkbox 2 selected');
    if get(h_checkBox17,'value') == 1
        set(boxes.box2,'visible','on');
    else
        set(boxes.box2,'visible','off');
    end
    
    % Checkbox for checkbox 3
elseif(strcmp(command_str,'checkBox18'))
    disp('Checkbox 3 selected');
    if get(h_checkBox18,'value') == 1
        set(boxes.box3,'visible','on');
    else
        set(boxes.box3,'visible','off');
    end
    
    % Checkbox for checkbox 4
elseif(strcmp(command_str,'checkBox19'))
    disp('Checkbox 4 selected');
    if get(h_checkBox19,'value') == 1
        set(boxes.box4,'visible','on');
    else
        set(boxes.box4,'visible','off');
    end
    
    % Checkbox for checkbox 5
elseif(strcmp(command_str,'checkBox20'))
    disp('Checkbox 5 selected');
    if get(h_checkBox20,'value') == 1
        set(boxes.box5,'visible','on');
    else
        set(boxes.box5,'visible','off');
    end
    
    % Checkbox for checkbox 6
elseif(strcmp(command_str,'checkBox21'))
    disp('Checkbox 6 selected');
    if get(h_checkBox21,'value') == 1
        set(boxes.box6,'visible','on');
    else
        set(boxes.box6,'visible','off');
    end
    
    % Checkbox for triplet slider group
elseif(strcmp(command_str,'tripletCheckBox'))
    if get(tripletCheckBox,'value') == 1
        set(triplet.empty_panel,'visible','on');
        disp('Triplet slider group selected')
    else
        set(triplet.empty_panel,'visible','off');
        disp('Triplet slider group deselected')
    end
    
    % Checkbox for continuous slider
elseif(strcmp(command_str,'continuousCheckBox'))
    if get(continuousCheckBox,'value') == 1
        set(continuous.empty_panel,'visible','on');
        disp('Continuous measurement slider selected');
    else
        set(continuous.empty_panel,'visible','off');
        disp('Continuous measurement slider deselected');
    end
    
    %----------------------------------------------------------------------
    % Checkboxes for radio buttons
    
    % Checkbox for radio 1
elseif(strcmp(command_str,'checkBox28'))
    disp('Radio button pair 1 selected');
    if get(h_checkBox28,'value') == 1
        set(radio1.panel,'visible','on');
    else
        set(radio1.panel,'visible','off');
    end
    
    %----------------------------------------------------------------------
    % Callbacks for radio buttons
elseif(strcmp(command_str,'Sliders'))
    set(h_panel3,'Visible','on');
    set(h_panel4,'Visible','off');
    set(h_panel5,'Visible','off');
    set(h_panel6,'Visible','off');
    set(h_panel7,'Visible','off');
    set(h_panel8,'Visible','off');
    
elseif(strcmp(command_str,'Check boxes'))
    set(h_panel3,'Visible','off');
    set(h_panel4,'Visible','on');
    set(h_panel5,'Visible','off');
    set(h_panel6,'Visible','off');
    set(h_panel7,'Visible','off');
    set(h_panel8,'Visible','off');
    
elseif(strcmp(command_str,'Open questions'))
    set(h_panel3,'Visible','off');
    set(h_panel4,'Visible','off');
    set(h_panel5,'Visible','on');
    set(h_panel6,'Visible','off');
    set(h_panel7,'Visible','off');
    set(h_panel8,'Visible','off');
    
elseif(strcmp(command_str,'Multiple choices'))
    set(h_panel3,'Visible','off');
    set(h_panel4,'Visible','off');
    set(h_panel5,'Visible','off');
    set(h_panel6,'Visible','on');
    set(h_panel7,'Visible','off');
    set(h_panel8,'Visible','off');
    
elseif(strcmp(command_str,'Miscellaneous'))
    set(h_panel3,'Visible','off');
    set(h_panel4,'Visible','off');
    set(h_panel5,'Visible','off');
    set(h_panel6,'Visible','off');
    set(h_panel7,'Visible','on');
    set(h_panel8,'Visible','off');
    
elseif(strcmp(command_str,'Custom'))
    set(h_panel3,'Visible','off');
    set(h_panel4,'Visible','off');
    set(h_panel5,'Visible','off');
    set(h_panel6,'Visible','off');
    set(h_panel7,'Visible','off');
    set(h_panel8,'Visible','on');
    
    %----------------------------------------------------------------------
    % Callbacks for buttons
    
    % save button
elseif(strcmp(command_str,'save'))
    
    set(0,'showhiddenhandles','on')
    % Find the annotation layer and set its parent property to h_panel2
    annotation_layer = findall(gcf,'-class','scribe.scribeaxes');
    set(annotation_layer,'parent',h_panel2)
    set(0,'showhiddenhandles','off')
    
    % Enable the buttons
    set(findobj(h_fig,'tag','continue_button'),'enable','on')
    set(findobj(h_fig,'tag','repeat_ref_button'),'enable','on')
    set(findobj(h_fig,'tag','repeat_stimulus_button'),'enable','on')
    set(findobj(h_fig,'tag','repeat_sscqe_stimulus_button'),'enable','on')
    set(findobj(h_fig,'tag','repeat_pc_stimuli_button'),'enable','on')
    set(findobj(h_fig,'tag','repeat_dynamic_still_ref_button'),'enable','on')
    
    % Enable sliders
    set(findobj(h_fig,'tag','slider1'),'enable','on')
    set(findobj(h_fig,'tag','slider2'),'enable','on')
    set(findobj(h_fig,'tag','slider3'),'enable','on')
    set(findobj(h_fig,'tag','slider4'),'enable','on')
    set(findobj(h_fig,'tag','slider5'),'enable','on')
    set(findobj(h_fig,'tag','slider6'),'enable','on')
    set(findobj(h_fig,'tag','slider7'),'enable','on')
    set(findobj(h_fig,'tag','slider8'),'enable','on')
    set(findobj(h_fig,'tag','slider9'),'enable','on')
    set(findobj(h_fig,'tag','slider10'),'enable','on')
    set(findobj(h_fig,'tag','slider11'),'enable','on')
    set(findobj(h_fig,'tag','slider12'),'enable','on')
    
    % Check which components are selected for this setup
    selected = 0;
    index = 1;
    children = get(h_panel2,'children');
    for i = 1 : length(children)
        if strcmp(get(children(i),'visible'),'on') == 1
            userdata = get(children(i),'userdata');
            if isempty(userdata) == 0
                if strcmp(userdata.question,'contentRelatedQuestions') == 0
                    selected(index) = children(i);
                    
                    % Check for triplet panel
                    if strcmp(get(selected(index),'tag'),'triplet_panel') == 1
                        offsprings = get(selected(index),'children');
                        ind = 1;
                        for k = 1 : length(offsprings)
                            if isempty(get(offsprings(k),'userdata')) == 0
                                sliders(ind) = offsprings(k);
                                ind = ind + 1;
                            end
                        end
                        ind = 1;
                        for j = index : index + 2
                            selected(j) = sliders(ind);
                            ind = ind + 1;
                        end
                        index = index + 2;
                    end
                    index = index + 1;
                end
            end
        end
    end
    
    % Get the component questions for struct field names
    for i = 1 : length(selected)
        userdata = get(selected(i),'userdata')
        if isempty(userdata)
            disp(['No components selected for QBU. Please select at '...
                'least one component.'])
            return
        end
        components(i) = {userdata.question};
    end
    
    % Check component types
    for i = 1 : length(selected)
        if strcmp(get(selected(i),'type'),'uipanel') == 0
            types(i) = {get(selected(i),'style')};
        else
            types(i) = {'panel'};
        end
    end
    
    % Check the subject response plot panel
    subject_response = findobj(h_panel2,'tag','subject_response_plot_position');
    if strcmp(get(subject_response,'visible'),'on')
        setup.subject_response_plot_position = get(subject_response,'position');
        set(subject_response,'visible','off')
    end
    
    % Check the continuous subject response plot panel
    subject_response = findobj(h_panel2,'tag','continuous_subject_response_plot_position');
    if strcmp(get(subject_response,'visible'),'on')
        setup.continuous_subject_response_plot_position = get(subject_response,'position');
        set(subject_response,'visible','off')
    end
    
    if strcmp(setup.standard,'Video SSCQE')
        
        if setup.extra_questions == 1
            % Save component related questions and types
            save([pwd filesep 'setups' filesep setup.name filesep ...
                'continuous_names.mat'],'components','types');
            
            % Save figure for 'back'- and 'modify'-buttons
            hgsave([pwd filesep 'setups' filesep setup.name filesep ...
                'continuous_qbu_screen.fig']);
            
            % create new figure for the questions
            questions_fig = figure('position',[1 1 200 200], ...
                'name','questions figure', ...
                'tag','questions_fig', ...
                'visible','off');
            
            % set the position panel to the new figure
            set(h_panel2,'Parent',questions_fig, ...
                'units','normalized', ...
                'Position',[0 0 1 1], ...
                'title','');
            
            % Save settings
            save([pwd filesep 'setups' filesep setup.name filesep setup.name '_sbu.mat'],...
                'setup','-append')
            
            % save the figure
            hgsave(questions_fig,[pwd filesep 'setups' filesep ...
                setup.name filesep setup.name '_continuous_qbu.fig'])
            disp(['Setup saved to: ' pwd filesep 'setups' filesep ...
                setup.name filesep setup.name '_continuous_qbu.fig'])
            
            position = get(gcf,'position');
            delete(h_fig);
            close all;
            
            % Re-initialize the QBU for extra questions
            setup.extra_questions = 2;
            % Check if we are modifying an existing setup and there exists
            % an extra questions figure already
            if setup.modifying == 1
                screen_file = [pwd filesep 'setups' filesep setup.name ...
                    filesep 'extra_qbu_screen.fig'];
                if exist(screen_file,'file')
                    % Load the figure
                    hgload(screen_file)
                    set(gcf,'position',position)
                    % Load saved handles
                    load([pwd filesep 'setups' filesep setup.name filesep ...
                        'extra_qbu_state.mat'])
                else
                    QBU('initilize',position)
                end
            elseif setup.modifying == 2
                tmp_name = setup.name;
                setup.name = setup.old_name;
                screen_file = [pwd filesep 'setups' filesep setup.name ...
                    filesep 'extra_qbu_screen.fig'];
                if exist(screen_file,'file')
                    % Load the figure
                    hgload(screen_file)
                    set(gcf,'position',position)
                    % Load saved handles
                    load([pwd filesep 'setups' filesep setup.name filesep ...
                        'extra_qbu_state.mat'])
                else
                    QBU('initilize',position)
                end
                % Restore the new setup name
                setup.name = tmp_name;
            else
                QBU('initilize',position)
            end
            
        elseif setup.extra_questions == 2
            % Save component related questions and types
            save([pwd filesep 'setups' filesep setup.name filesep ...
                'extra_names.mat'],'components','types');
            
            % Save figure for 'back'- and 'modify'-buttons
            hgsave([pwd filesep 'setups' filesep setup.name filesep ...
                'extra_qbu_screen.fig']);
            
            % create new figure for the questions
            questions_fig = figure('position',[1 1 200 200], ...
                'name','questions figure', ...
                'tag','questions_fig', ...
                'visible','off');
            
            % set the position panel to the new figure
            set(h_panel2,'Parent',questions_fig, ...
                'units','normalized', ...
                'Position',[0 0 1 1], ...
                'title','');
            
            % Save settings
            save([pwd filesep 'setups' filesep setup.name filesep setup.name '_sbu.mat'],...
                'setup','-append')
            
            % save the figure
            hgsave(questions_fig,[pwd filesep 'setups' filesep ...
                setup.name filesep setup.name '_extra_qbu.fig']);
            disp(['Setup saved to: ' pwd filesep 'setups' filesep ...
                setup.name filesep setup.name '_extra_qbu.fig']);
            
            handles = guihandles(gcf);
            guidata(gcf,handles);
            qbu_state = guidata(gcbo);
            save([pwd filesep 'setups' filesep setup.name filesep ...
                'extra_qbu_state.mat'],'qbu_state');
            
            setup.extra_questions = 1;
            
            delete(h_fig);
            close all;
            clear all;
            
            VQone()
            
        else
            % Save component related questions and types
            save([pwd filesep 'setups' filesep setup.name filesep ...
                'continuous_names.mat'],'components','types');
            
            % Save figure for 'back'- and 'modify'-buttons
            hgsave([pwd filesep 'setups' filesep setup.name filesep ...
                'continuous_qbu_screen.fig']);
            
            % create new figure for the questions
            questions_fig = figure('position',[1 1 200 200], ...
                'name','questions figure', ...
                'tag','questions_fig', ...
                'visible','off');
            
            % set the position panel to the new figure
            set(h_panel2,'Parent',questions_fig, ...
                'units','normalized', ...
                'Position',[0 0 1 1], ...
                'title','');
            
            % Save settings
            save([pwd filesep 'setups' filesep setup.name filesep setup.name '_sbu.mat'],...
                'setup','-append')
            
            % save the figure
            hgsave(questions_fig,[pwd filesep 'setups' filesep ...
                setup.name filesep setup.name '_continuous_qbu.fig'])
            disp(['Setup saved to: ' pwd filesep 'setups' filesep ...
                setup.name filesep setup.name '_continuous_qbu.fig'])
            
            handles = guihandles(gcf);
            guidata(gcf,handles);
            qbu_state = guidata(gcbo);
            save([pwd filesep 'setups' filesep setup.name filesep ...
                'continuous_qbu_state.mat'],'qbu_state');
            
            delete(h_fig);
            close all;
            clear all;
            
            VQone()
        end
        
        % All other standards
    else
        % Save component related questions and types
        save([pwd filesep 'setups' filesep setup.name filesep ...
            'names.mat'],'components','types');
        
        % Save figure for 'back'- and 'modify'-buttons
        hgsave([pwd filesep 'setups' filesep setup.name filesep ...
            'qbu_screen.fig']);
        
        % create new figure for the questions
        questions_fig = figure('position',[1 1 200 200], ...
            'name','questions figure', ...
            'tag','questions_fig', ...
            'visible','off');
        
        % set the position panel to the new figure
        set(h_panel2,'Parent',questions_fig, ...
            'units','normalized', ...
            'Position',[0 0 1 1], ...
            'title','');
        
        % save the figure
        hgsave(questions_fig,[pwd filesep 'setups' filesep setup.name ...
            filesep setup.name '_qbu.fig']);
        
        handles = guihandles(gcf);
        guidata(gcf,handles);
        
        qbu_state = guidata(gcbo);
        
        save([pwd filesep 'setups' filesep setup.name filesep ...
            'qbu_state.mat'],'qbu_state');
        
        % Save settings
        save([pwd filesep 'setups' filesep setup.name filesep setup.name '_sbu.mat'],...
            'setup','-append')
        
        disp(['Setup saved to: ' pwd filesep 'setups' filesep setup.name ...
            filesep 'qbu_state.mat'])
        
        % Close all other open figures before QBU
        h_figs = get(0,'children');
        for i = 1 : length(h_figs)
            if h_figs(i) ~= h_fig
                disp(h_figs)
                handle = h_figs(i)
                delete(handle)
            end
        end
        %close hidden
        
        % Delete QBU figure and close and clear all
        delete(h_fig);
        close all;
        clear all;
        
        VQone();
    end
    
    %----------------------------------------------------------------------
    
    % Go back -button
elseif strcmp(command_str,'go_back') == 1
    close all;
    if strcmp(standard,'Questions only') == 0
        hgload([pwd filesep 'setups' filesep setup.name filesep ...
            'sbu_screen.fig'])
    else
        hgload([pwd filesep 'setups' filesep setup.name filesep ...
            'start_screen.fig'])
    end
end


%%% CALLBACK FUNCTIONS %---------------------------------------------------

% Sliders %----------------------------------------------------------------
function slider_callback(source,~)
global current_data data
disp(round(get(source,'value')));
slider_panel = get(source,'parent');
str = get(slider_panel,'title');
% Check string validity Remove spaces and punctuation
str = regexprep(str,'[^\w'']','');
for i = 1 : length(str)
    if strcmp(str(i),'ˆ') == 1
        str(i) = 'o';
    elseif strcmp(str(i),'‰') == 1
        str(i) = 'a';
    end
end
current_data.(str) = round(get(source,'value'));
% Update flow control
userdata = get(get(source,'parent'),'userdata');
userdata.isTouched = 'true';
set(get(source,'parent'),'userdata',userdata);
% Update subject response plot
if strcmp(userdata.isPlotting,'true')
    if isfield(data,(char(userdata.question)))
        new_plot = [data.(char(userdata.question)) current_data.(char(userdata.question))];
    else
        new_plot = current_data.(char(userdata.question));
    end
    plotSubjectResponse(new_plot,get(source,'min'),get(source,'max'));
end

function slider_checkbox_callback(source,~,group)%-------------------------
disp('Slider selected');
    if get(source,'value') == 1
        set(group.empty_panel,'visible','on');
    else
        set(group.empty_panel,'visible','off');
    end


%--------------------------------------------------------------------------
% Slider group for triplet-------------------------------------------------

% Triplet slider 1
function triplet_slider1(source,~)
global current_data
value = round(get(source,'value'));
set(source,'value',value)
if value == 1
    value = 3;
elseif value == 3
    value = 1;
end
disp(strcat('Left image: ',num2str(value)))
current_data.vasen = value;

% Triplet slider 2
function triplet_slider2(source,~)
global current_data
value = round(get(source,'value'));
set(source,'value',value)
if value == 1
    value = 3;
elseif value == 3
    value = 1;
end
disp(strcat('Center image: ',num2str(value)))
current_data.keskimmainen = value;

% Triplet slider 3
function triplet_slider3(source,~)
global current_data
value = round(get(source,'value'));
set(source,'value',value)
if value == 1
    value = 3;
elseif value == 3
    value = 1;
end
disp(strcat('Right image: ',num2str(value)))
current_data.oikea = value;

% Continuous slider--------------------------------------------------------
function continuous_slider(source,~)
disp(round(get(source,'value')))

% Push Buttons%---------------------------------------------------------------------------------------------------------------

% Continue button
function continue_button(hObject,~)
global current_data data evaluation_number setup test current_continuous_data
global continuous_data
disp('Continue button pressed')
disp(current_data)

tElapsed=toc(test.tStart);

% Load the component names for this setup
if strcmp(setup.standard,'Video SSCQE') && setup.extra_questions == 1
    load([pwd filesep 'setups' filesep setup.name filesep 'extra_names.mat'])
elseif strcmp(setup.standard,'Video SSCQE') && setup.extra_questions == 0
    load([pwd filesep 'setups' filesep setup.name filesep 'continuous_names.mat'])
elseif strcmp(setup.standard,'Video SSCQE') && setup.extra_questions == 2
    load([pwd filesep 'setups' filesep setup.name filesep 'continuous_names.mat'])
else
    load([pwd filesep 'setups' filesep setup.name filesep 'names.mat'])
end

% Check which components are selected for this setup
index = 1;
children = get(get(hObject,'parent'),'children');
for i = 1 : length(children)
    if strcmp(get(children(i),'visible'),'on') == 1
        if isempty(get(children(i),'userdata')) == 0
            selected(index) = children(i);
            index = index + 1;
        end
    end
end

% Check flow control for each component
stopHere = 0;
index = 1;

% Check triplet panel
if strcmp(get(findobj(gcf,'tag','triplet_panel'),'visible'),'on') == 1
    if current_data.vasen == current_data.keskimmainen || ...
            current_data.vasen == current_data.oikea ||...
            current_data.oikea == current_data.keskimmainen
        userdata = get(findobj(gcf,'tag','triplet_panel'),'userdata');
        stopHere = 1;
    else % Make the order variables
        switch current_data.vasen
            case 1
                data.order1(3*(evaluation_number-1)+1:...
                    3*(evaluation_number-1)+3) = [test.camera1 0 0];
                data.rank1(3*(evaluation_number-1)+1:...
                    3*(evaluation_number-1)+3) = [test.camera1 0 0];
                camera_nr1 = [test.camera1 0 0];
                stimulus(1) = test.camera1_file;
            case 2
                data.order2(3*(evaluation_number-1)+1:...
                    3*(evaluation_number-1)+3) = [test.camera1 0 0];
                data.rank2(3*(evaluation_number-1)+1:...
                    3*(evaluation_number-1)+3) = [0 test.camera1 0];
                camera_nr1 = [0 test.camera1 0];
                stimulus(2) = test.camera1_file;
            case 3
                data.order3(3*(evaluation_number-1)+1:...
                    3*(evaluation_number-1)+3) = [test.camera1 0 0];
                data.rank3(3*(evaluation_number-1)+1:...
                    3*(evaluation_number-1)+3) = [0 0 test.camera1];
                camera_nr1 = [0 0 test.camera1];
                stimulus(3) = test.camera1_file;
        end
        switch current_data.keskimmainen
            case 1
                data.order1(3*(evaluation_number-1)+1:...
                    3*(evaluation_number-1)+3) = [test.camera2 0 0];
                data.rank1(3*(evaluation_number-1)+1:...
                    3*(evaluation_number-1)+3) = [test.camera2 0 0];
                camera_nr2 = [test.camera2 0 0];
                stimulus(1) = test.camera2_file;
            case 2
                data.order2(3*(evaluation_number-1)+1:...
                    3*(evaluation_number-1)+3) = [test.camera2 0 0];
                data.rank2(3*(evaluation_number-1)+1:...
                    3*(evaluation_number-1)+3) = [0 test.camera2 0];
                camera_nr2 = [0 test.camera2 0];
                stimulus(2) = test.camera2_file;
            case 3
                data.order3(3*(evaluation_number-1)+1:...
                    3*(evaluation_number-1)+3) = [test.camera2 0 0];
                data.rank3(3*(evaluation_number-1)+1:...
                    3*(evaluation_number-1)+3) = [0 0 test.camera2];
                camera_nr2 = [0 0 test.camera2];
                stimulus(3) = test.camera2_file;
        end
        switch current_data.oikea
            case 1
                data.order1(3*(evaluation_number-1)+1:...
                    3*(evaluation_number-1)+3) = [test.camera3 0 0];
                data.rank1(3*(evaluation_number-1)+1:...
                    3*(evaluation_number-1)+3) = [test.camera3 0 0];
                camera_nr3 = [test.camera3 0 0];
                stimulus(1) = test.camera3_file;
            case 2
                data.order2(3*(evaluation_number-1)+1:...
                    3*(evaluation_number-1)+3) = [test.camera3 0 0];
                data.rank2(3*(evaluation_number-1)+1:...
                    3*(evaluation_number-1)+3) = [0 test.camera3 0];
                camera_nr3 = [0 test.camera3 0];
                stimulus(2) = test.camera3_file;
            case 3
                data.order3(3*(evaluation_number-1)+1:...
                    3*(evaluation_number-1)+3) = [test.camera3 0 0];
                data.rank3(3*(evaluation_number-1)+1:...
                    3*(evaluation_number-1)+3) = [0 0 test.camera3];
                camera_nr3 = [0 0 test.camera3];
                stimulus(3) = test.camera3_file;
        end
        data.camera_nr(3*(evaluation_number-1)+1:3*(evaluation_number-1)+3) ...
            = camera_nr1 + camera_nr2 + camera_nr3;
        data.rank(3*(evaluation_number-1)+1:3*(evaluation_number-1)+3) ...
            = [1 2 3];
        data.stimuli(3*(evaluation_number-1)+1:3*(evaluation_number-1)+3) ...
            = stimulus;
        
        current_data.timeElapsed = round(tElapsed);
        
    end
end

% Check pair comparison radio buttons
if strcmp(get(findobj(gcf,'tag','radio_panel'),'visible'),'on') && ...
        (strcmp(setup.standard,'Still PC') || strcmp(setup.standard,'Video PC'))
    if current_data.vasen == current_data.oikea
        stopHere = 1;
        disp('Choose the pair comparison radio button.')
    else % Make the order variables
        switch current_data.vasen
            case 0
                data.order2(2*(evaluation_number-1)+1:...
                    2*(evaluation_number-1)+2) = [test.camera1 0];
                data.rank2(2*(evaluation_number-1)+1:...
                    2*(evaluation_number-1)+2) = [0 test.camera1];
                camera_nr1 = [0 test.camera1];
                stimulus(2) = test.camera1_file;
            case 1
                data.order1(2*(evaluation_number-1)+1:...
                    2*(evaluation_number-1)+2) = [test.camera1 0];
                data.rank1(2*(evaluation_number-1)+1:...
                    2*(evaluation_number-1)+2) = [test.camera1 0];
                camera_nr1 = [test.camera1 0];
                stimulus(1) = test.camera1_file;
        end
        switch current_data.oikea
            case 0
                data.order2(2*(evaluation_number-1)+1:...
                    2*(evaluation_number-1)+2) = [test.camera2 0];
                data.rank2(2*(evaluation_number-1)+1:...
                    2*(evaluation_number-1)+2) = [0 test.camera2];
                camera_nr2 = [0 test.camera2];
                stimulus(2) = test.camera2_file;
            case 1
                data.order1(2*(evaluation_number-1)+1:...
                    2*(evaluation_number-1)+2) = [test.camera2 0];
                data.rank1(2*(evaluation_number-1)+1:...
                    2*(evaluation_number-1)+2) = [test.camera2 0];
                camera_nr2 = [test.camera2 0];
                stimulus(1) = test.camera2_file;
        end
        
        data.camera_nr(2*(evaluation_number-1)+1:2*(evaluation_number-1)+2) ...
            = camera_nr1 + camera_nr2;
        data.rank(2*(evaluation_number-1)+1:2*(evaluation_number-1)+2) ...
            = [1 2];
        data.stimuli(2*(evaluation_number-1)+1:2*(evaluation_number-1)+2) ...
            = stimulus;
        
        current_data.timeElapsed = round(tElapsed);
        
    end
end

while stopHere == 0 && index <= length(selected)
    userdata = get(selected(index),'userdata');
    if strcmp(userdata.flowControl,'on') == 1
        if strcmp(userdata.isTouched,'false') == 1
            userdata.isTouched = 'true';
            set(selected(index),'userdata',userdata);
            stopHere = 1;
        end
    end
    index = index + 1;
end

% If flow check is OK: continue
if stopHere == 0
    % If nothing is touched, then every component must get a default value
    if isempty(current_data)
        disp('Current data is empty, set default values.')
        for i = 1 : length(components)
            if strcmp(types(i),'checkbox') == 1
                current_data.(char(components(i))) = 0;
            else
                current_data.(char(components(i))) = {'~'};
            end
        end
    end
    
    % Save current data to data struct
    fields = fieldnames(current_data);
    
    % Check that every component in the setup gets a result, 0 for no touch
    for i = 1 : length(components)
        found = 0;
        index = 1;
        while found == 0  && index <= length(fields)
            if strcmp(components(i),fields(index)) == 1
                found = 1;
            end
            index = index + 1;
        end
        % If the component wasn't found in current_data: its value is default
        if found == 0
            if strcmp(types(i),'checkbox') == 1
                current_data.(char(components(i))) = 0;
            else
                current_data.(char(components(i))) = {'~'};
            end
        end
        % Update fieldnames
        fields = fieldnames(current_data);
    end
    
    for i = 1 :length(fields)
        str = char(fields(i));
        % If string value, take the whole array.
        value = {current_data.(str)};
        % If double value, take only the first item from the array.
        if strcmp(class(value{1}),'double') == 1
            value = value{1};
        end
        
        % Multiply values for triplet and pc standards
        if strcmp(setup.standard,'Still triplet')
            data.(str)(3*(evaluation_number-1)+1) = value;
            data.(str)(3*(evaluation_number-1)+2) = value;
            data.(str)(3*(evaluation_number-1)+3) = value;
        elseif strcmp(setup.standard,'Still PC')
            data.(str)(2*(evaluation_number-1)+1) = value;
            data.(str)(2*(evaluation_number-1)+2) = value;
        elseif strcmp(setup.standard,'Video PC')
            data.(str)(2*(evaluation_number-1)+1) = value;
            data.(str)(2*(evaluation_number-1)+2) = value;
        else
            data.(str)(evaluation_number) = value;
        end
        
    end
    
    
    % Remove triplet slider and PC button values from the data
    if strcmp(get(findobj(gcf,'tag','triplet_panel'),'visible'),'on')
        data = rmfield(data, 'vasen');
        data = rmfield(data, 'keskimmainen');
        data = rmfield(data, 'oikea');
    elseif strcmp(get(findobj(gcf,'tag','radio_panel'),'visible'),'on')
        data = rmfield(data, 'vasen');
        data = rmfield(data, 'oikea');
    end
    
    % Save continuous measurement data if selected
    if strcmp(setup.standard,'Video SSCQE')
        
        disp(current_continuous_data.file)
        disp(current_continuous_data.values)
        
        continuous_data.values.(['trial' num2str(evaluation_number)]) = ...
            current_continuous_data.values;
        continuous_data.file.(['trial' num2str(evaluation_number)]) = ...
            {current_continuous_data.file};
        continuous_data.evaluation_number(evaluation_number) = ...
            evaluation_number;
    end
    
    if strcmp(setup.standard,'Still triplet')
        data.evaluation_number(3*(evaluation_number-1)+1) = evaluation_number;
        data.evaluation_number(3*(evaluation_number-1)+2) = evaluation_number;
        data.evaluation_number(3*(evaluation_number-1)+3) = evaluation_number;
        
        data.subject(3*(evaluation_number-1)+1) = {test.subject};
        data.subject(3*(evaluation_number-1)+2) = {test.subject};
        data.subject(3*(evaluation_number-1)+3) = {test.subject};
        
        data.sex(3*(evaluation_number-1)+1) = {test.sex};
        data.sex(3*(evaluation_number-1)+2) = {test.sex};
        data.sex(3*(evaluation_number-1)+3) = {test.sex};
        
        data.age(3*(evaluation_number-1)+1) = {test.age};
        data.age(3*(evaluation_number-1)+2) = {test.age};
        data.age(3*(evaluation_number-1)+3) = {test.age};
        
        data.subject_number(3*(evaluation_number-1)+1) = {test.test_index};
        data.subject_number(3*(evaluation_number-1)+2) = {test.test_index};
        data.subject_number(3*(evaluation_number-1)+3) = {test.test_index};
    elseif strcmp(setup.standard,'Still PC') || strcmp(setup.standard,'Video PC')
        data.evaluation_number(2*(evaluation_number-1)+1) = evaluation_number;
        data.evaluation_number(2*(evaluation_number-1)+2) = evaluation_number;
        
        data.subject(2*(evaluation_number-1)+1) = {test.subject};
        data.subject(2*(evaluation_number-1)+2) = {test.subject};
        
        data.sex(2*(evaluation_number-1)+1) = {test.sex};
        data.sex(2*(evaluation_number-1)+2) = {test.sex};
        
        data.age(2*(evaluation_number-1)+1) = {test.age};
        data.age(2*(evaluation_number-1)+2) = {test.age};
        
        data.subject_number(2*(evaluation_number-1)+1) = {test.test_index};
        data.subject_number(2*(evaluation_number-1)+2) = {test.test_index};
    else
        data.evaluation_number(evaluation_number) = evaluation_number;
        data.subject(evaluation_number) = {test.subject};
        data.sex(evaluation_number) = {test.sex};
        data.age(evaluation_number) = {test.age};
        data.subject_number(evaluation_number) = {test.test_index};
        data.timeElapsed(evaluation_number) = round(tElapsed);
    end
    
    disp(data);
    
    % Make backup data file before continuing
    save([pwd filesep 'setups' filesep setup.name filesep ...
        'running_backup.mat'],'data');
    % Backup continuous measurement data if selected
    if strcmp(setup.standard,'Video SSCQE')
        save([pwd filesep 'setups' filesep setup.name filesep ...
            'running_backup.mat'],'data','continuous_data','-append');
    end
    
    clear global current_data
    
    evaluation_number = evaluation_number + 1;
    
    % Clear isTouched fields for every component
    for i = 1 : length(selected)
        userdata = get(selected(i),'userdata');
        userdata.isTouched = 'false';
        set(selected(i),'userdata',userdata);
    end
    
    % Find the questions figure and delete it
    panel = get(hObject,'Parent');
    parent = get(panel,'Parent');
    delete(parent);
    
    return
else % Flow check failure
    h_wdlg = warndlg(userdata.stopMessage,'Warning','replace');
    set(h_wdlg, 'position', [400 -450 200 80]);
end

% Property buttons---------------------------------------------------------
%
% Sliders
function empty1_props(~,~,empty1)
slider_prop_editor(empty1)
set(empty1.h_checkBox6,'string',get(empty1.empty_panel,'title'));
% Get the struct field name from question
s = get(empty1.empty_panel,'title');
% Remove spaces and punctuation
s = regexprep(s,'[^\w'']','');
% Check string validity
for i = 1 : length(s)
    if strcmp(s(i),'ˆ') == 1
        s(i) = 'o';
    elseif strcmp(s(i),'‰') == 1
        s(i) = 'a';
    end
end
userdata = get(empty1.empty_panel,'userdata');
userdata.question = s;
set(empty1.empty_panel,'userdata',userdata);

function empty2_props(~,~,empty2)
slider_prop_editor(empty2)
set(empty2.h_checkBox7,'string',get(empty2.empty_panel,'title'));
% Get the struct field name from question
s = get(empty2.empty_panel,'title');
% Remove spaces and punctuation
s = regexprep(s,'[^\w'']','');
% Check string validity
for i = 1 : length(s)
    if strcmp(s(i),'ˆ') == 1
        s(i) = 'o';
    elseif strcmp(s(i),'‰') == 1
        s(i) = 'a';
    end
end
userdata = get(empty2.empty_panel,'userdata');
userdata.question = s;
set(empty2.empty_panel,'userdata',userdata);

function overall_props(~,~,overall)
slider_prop_editor(overall)
set(overall.h_checkBox,'string',get(overall.empty_panel,'title'));
% Get the struct field name from question
s = get(overall.empty_panel,'title');
% Remove spaces and punctuation
s = regexprep(s,'[^\w'']','');
% Check string validity
for i = 1 : length(s)
    if strcmp(s(i),'ˆ') == 1
        s(i) = 'o';
    elseif strcmp(s(i),'‰') == 1
        s(i) = 'a';
    end
end
userdata = get(overall.empty_panel,'userdata');
userdata.question = s;
set(overall.empty_panel,'userdata',userdata);

function focus_props(~,~,focus)
slider_prop_editor(focus)
set(focus.h_checkBox,'string',get(focus.empty_panel,'title'));
% Get the struct field name from question
s = get(focus.empty_panel,'title');
% Remove spaces and punctuation
s = regexprep(s,'[^\w'']','');
% Check string validity
for i = 1 : length(s)
    if strcmp(s(i),'ˆ') == 1
        s(i) = 'o';
    elseif strcmp(s(i),'‰') == 1
        s(i) = 'a';
    end
end
userdata = get(focus.empty_panel,'userdata');
userdata.question = s;
set(focus.empty_panel,'userdata',userdata);

function graininess_props(~,~,graininess)
slider_prop_editor(graininess)
set(graininess.h_checkBox,'string',get(graininess.empty_panel,'title'));
% Get the struct field name from question
s = get(graininess.empty_panel,'title');
% Remove spaces and punctuation
s = regexprep(s,'[^\w'']','');
% Check string validity
for i = 1 : length(s)
    if strcmp(s(i),'ˆ') == 1
        s(i) = 'o';
    elseif strcmp(s(i),'‰') == 1
        s(i) = 'a';
    end
end
userdata = get(graininess.empty_panel,'userdata');
userdata.question = s;
set(graininess.empty_panel,'userdata',userdata);

function lightness_props(~,~,lightness)
slider_prop_editor(lightness)
set(lightness.h_checkBox,'string',get(lightness.empty_panel,'title'));
% Get the struct field name from question
s = get(lightness.empty_panel,'title');
% Remove spaces and punctuation
s = regexprep(s,'[^\w'']','');
% Check string validity
for i = 1 : length(s)
    if strcmp(s(i),'ˆ') == 1
        s(i) = 'o';
    elseif strcmp(s(i),'‰') == 1
        s(i) = 'a';
    end
end
userdata = get(lightness.empty_panel,'userdata');
userdata.question = s;
set(lightness.empty_panel,'userdata',userdata);

function saturation_props(~,~,saturation)
slider_prop_editor(saturation)
set(saturation.h_checkBox,'string',get(saturation.empty_panel,'title'));
% Get the struct field name from question
s = get(saturation.empty_panel,'title');
% Remove spaces and punctuation
s = regexprep(s,'[^\w'']','');
% Check string validity
for i = 1 : length(s)
    if strcmp(s(i),'ˆ') == 1
        s(i) = 'o';
    elseif strcmp(s(i),'‰') == 1
        s(i) = 'a';
    end
end
userdata = get(saturation.empty_panel,'userdata');
userdata.question = s;
set(saturation.empty_panel,'userdata',userdata);

function slider_props(~,~,group)
slider_prop_editor(group)
set(group.h_checkBox,'string',get(group.empty_panel,'title'));
% Get the struct field name from question
s = get(group.empty_panel,'title');
% Remove spaces and punctuation
s = regexprep(s,'[^\w'']','');
% Check string validity
for i = 1 : length(s)
    if strcmp(s(i),'ˆ') == 1
        s(i) = 'o';
    elseif strcmp(s(i),'‰') == 1
        s(i) = 'a';
    end
end
userdata = get(group.empty_panel,'userdata');
userdata.question = s;
set(group.empty_panel,'userdata',userdata);

% Triplet props
function triplet_props(~,~,triplet)
triplet_prop_editor(triplet)

% Popups
function popup_props(~,~,popup)
popup_prop_editor(popup)
str = get(popup,'string');
s = str{1};
% Get the struct field name from question
% Remove spaces and punctuation
s = regexprep(s,'[^\w'']','');
% Check string validity
for i = 1 : length(s)
    if strcmp(s(i),'ˆ') == 1
        s(i) = 'o';
    elseif strcmp(s(i),'‰') == 1
        s(i) = 'a';
    end
end
userdata = get(popup,'userdata');
userdata.question = s;
set(popup,'userdata',userdata);

% Continuous props
function continuous_props(~,~,continuous)
slider_prop_editor(continuous)
% Get the struct field name from question
s = get(continuous.empty_panel,'title');
% Remove spaces and punctuation
s = regexprep(s,'[^\w'']','');
% Check string validity
for i = 1 : length(s)
    if strcmp(s(i),'ˆ') == 1
        s(i) = 'o';
    elseif strcmp(s(i),'‰') == 1
        s(i) = 'a';
    end
end
userdata = get(continuous.empty_panel,'userdata');
userdata.question = s;
set(continuous.empty_panel,'userdata',userdata);
set(continuous.h_slider,'userdata',userdata);

% Open questions
function open_props(~,~,open)
open_prop_editor(open)
% Get the struct field name from question
s = get(open,'title');
% Remove spaces and punctuation
s = regexprep(s,'[^\w'']','');
% Check string validity
for i = 1 : length(s)
    if strcmp(s(i),'ˆ') == 1
        s(i) = 'o';
    elseif strcmp(s(i),'‰') == 1
        s(i) = 'a';
    end
end
userdata = get(open,'userdata');
userdata.question = s;
set(open,'userdata',userdata);

% Checkboxes
function box_props(~,~,box)
checkbox_prop_editor(box)
% Get the struct field name from question
s = get(box,'string');
% Remove spaces and punctuation
s = regexprep(s,'[^\w'']','');
% Check string validity
for i = 1 : length(s)
    if strcmp(s(i),'ˆ') == 1
        s(i) = 'o';
    elseif strcmp(s(i),'‰') == 1
        s(i) = 'a';
    end
end

userdata = get(box,'userdata');
userdata.question = s;
set(box,'userdata',userdata);

% Radio buttons
function radio_props(~,~,radio)
radio_prop_editor(radio)
% Get the struct field name from question
s = get(radio.panel,'title');
% Remove spaces and punctuation
s = regexprep(s,'[^\w'']','');
% Check string validity
for i = 1 : length(s)
    if strcmp(s(i),'ˆ') == 1
        s(i) = 'o';
    elseif strcmp(s(i),'‰') == 1
        s(i) = 'a';
    end
end

userdata = get(radio.panel,'userdata');
userdata.question = s;
set(radio.panel,'userdata',userdata);
set(radio.button(1),'userdata',userdata)
set(radio.button(2),'userdata',userdata)

% Radio button group %-----------------------------------------------------
function selcbk(source,~)
text = (get(get(source,'SelectedObject'),'String'));
disp(text);

if strcmp(text,'Sliders')
    QBU('Sliders')
elseif strcmp(text,'Check boxes')
    QBU('Check boxes')
elseif strcmp(text,'Open questions')
    QBU('Open questions')
elseif strcmp(text,'Miscellaneous')
    QBU('Miscellaneous')
elseif strcmp(text,'Custom')
    QBU('Custom')
else % multiple choices
    QBU('Multiple choices')
end

% Popup selections---------------------------------------------------------
%
% Popup 1 callback
function popup1_sel(source,~)
global current_data
str = get(source, 'String');
val = get(source, 'value');

if val == 1 % Question text selected
    % Remove spaces and punctuation
    s = regexprep(str{1},'[^\w'']','');
    % Check string validity
    for i = 1 : length(s)
        if strcmp(s(i),'ˆ') == 1
            s(i) = 'o';
        elseif strcmp(s(i),'‰') == 1
            s(i) = 'a';
        end
    end
    current_data.(s) = 0;
else
    % Remove spaces and punctuation
    s = regexprep(str{1},'[^\w'']','');
    % Check string validity
    for i = 1 : length(s)
        if strcmp(s(i),'ˆ') == 1
            s(i) = 'o';
        elseif strcmp(s(i),'‰') == 1
            s(i) = 'a';
        end
    end
    current_data.(s) = str{val};
end

% Update flow control
userdata = get(source,'userdata');
userdata.isTouched = 'true';
set(source,'userdata',userdata);

% Popup 2 callback---------------------------------------------------------
function popup2_sel(source,~)
global current_data
str = get(source, 'String');
val = get(source, 'value');

if val == 1 % Question text selected
    % Remove spaces and punctuation
    s = regexprep(str{1},'[^\w'']','');
    % Check string validity
    for i = 1 : length(s)
        if strcmp(s(i),'ˆ') == 1
            s(i) = 'o';
        elseif strcmp(s(i),'‰') == 1
            s(i) = 'a';
        end
    end
    current_data.(s) = 0;
else
    % Remove spaces and punctuation
    s = regexprep(str{1},'[^\w'']','');
    % Check string validity
    for i = 1 : length(s)
        if strcmp(s(i),'ˆ') == 1
            s(i) = 'o';
        elseif strcmp(s(i),'‰') == 1
            s(i) = 'a';
        end
    end
    current_data.(s) = str{val};
end
% Update flow control
userdata = get(source,'userdata');
userdata.isTouched = 'true';
set(source,'userdata',userdata);

% Popup 3 callback---------------------------------------------------------
function popup3_sel(source,~)
global current_data
str = get(source, 'String');
val = get(source, 'value');

if val == 1 % Question text selected
    % Remove spaces and punctuation
    s = regexprep(str{1},'[^\w'']','');
    % Check string validity
    for i = 1 : length(s)
        if strcmp(s(i),'ˆ') == 1
            s(i) = 'o';
        elseif strcmp(s(i),'‰') == 1
            s(i) = 'a';
        end
    end
    current_data.(s) = 0;
else
    % Remove spaces and punctuation
    s = regexprep(str{1},'[^\w'']','');
    % Check string validity
    for i = 1 : length(s)
        if strcmp(s(i),'ˆ') == 1
            s(i) = 'o';
        elseif strcmp(s(i),'‰') == 1
            s(i) = 'a';
        end
    end
    current_data.(s) = str{val};
end
% Update flow control
userdata = get(source,'userdata');
userdata.isTouched = 'true';
set(source,'userdata',userdata);


% Open question selections-------------------------------------------------
%
% Open question 1 callback
function open_question1(source,~,S)
global current_data
disp(get(source,'string'));

% Get the struct field name from question
s = get(S,'title');
% Remove spaces and punctuation
s = regexprep(s,'[^\w'']','');
% Check string validity
for i = 1 : length(s)
    if strcmp(s(i),'ˆ') == 1
        s(i) = 'o';
    elseif strcmp(s(i),'‰') == 1
        s(i) = 'a';
    end
end

% Check that there are no new lines in the returned string
data_string = get(source,'string');
%data_string = regexprep(data_string,'\n',' ');

current_data.(s) = data_string;
% Update flow control
userdata = get(get(source,'parent'),'userdata');
userdata.isTouched = 'true';
set(get(source,'parent'),'userdata',userdata);

% Open question 2 callback-------------------------------------------------
function open_question2(source,~,S)
global current_data
disp(get(source,'string'));

% Get the struct field name from question
s = get(S,'title');
% Remove spaces and punctuation
s = regexprep(s,'[^\w'']','');
% Check string validity
for i = 1 : length(s)
    if strcmp(s(i),'ˆ') == 1
        s(i) = 'o';
    elseif strcmp(s(i),'‰') == 1
        s(i) = 'a';
    end
end
current_data.(s) = get(source,'string');
% Update flow control
userdata = get(get(source,'parent'),'userdata');
userdata.isTouched = 'true';
set(get(source,'parent'),'userdata',userdata);

% Open question 3 callback-------------------------------------------------
function open_question3(source,~,S)
global current_data
disp(get(source,'string'));

% Get the struct field name from question
s = get(S,'title');
% Remove spaces and punctuation
s = regexprep(s,'[^\w'']','');
% Check string validity
for i = 1 : length(s)
    if strcmp(s(i),'ˆ') == 1
        s(i) = 'o';
    elseif strcmp(s(i),'‰') == 1
        s(i) = 'a';
    end
end
current_data.(s) = get(source,'string');
% Update flow control
userdata = get(get(source,'parent'),'userdata');
userdata.isTouched = 'true';
set(get(source,'parent'),'userdata',userdata);

% Open question 4 callback-------------------------------------------------
function open_question4(source,~,S)
global current_data
disp(get(source,'string'));

% Get the struct field name from question
s = get(S,'title');
% Remove spaces and punctuation
s = regexprep(s,'[^\w'']','');
% Check string validity
for i = 1 : length(s)
    if strcmp(s(i),'ˆ') == 1
        s(i) = 'o';
    elseif strcmp(s(i),'‰') == 1
        s(i) = 'a';
    end
end
current_data.(s) = get(source,'string');
% Update flow control
userdata = get(get(source,'parent'),'userdata');
userdata.isTouched = 'true';
set(get(source,'parent'),'userdata',userdata);

% Checkbox questions callback----------------------------------------------
function checkboxes(source,~)
global current_data
disp(strcat(get(source,'string'),': ',num2str(get(source,'value'))));

% Get the struct field name from question
s = get(source,'string');
% Remove spaces and punctuation
s = regexprep(s,'[^\w'']','');
% Check string validity
for i = 1 : length(s)
    if strcmp(s(i),'ˆ') == 1
        s(i) = 'o';
    elseif strcmp(s(i),'‰') == 1
        s(i) = 'a';
    end
end
current_data.(s) = get(source,'value');

% Radio button pairs callback----------------------------------------------
function radio_callback(source,~,radio)
global current_data

% Get the struct field name from question
str = get(get(source,'parent'),'title');
% Remove spaces and punctuation
str = regexprep(str,'[^\w'']','');
% Check string validity
for i = 1 : length(str)
    if strcmp(str(i),'ˆ') == 1
        str(i) = 'o';
    elseif strcmp(str(i),'‰') == 1
        str(i) = 'a';
    end
end

if strcmp(get(source,'tag'),'button1') == 1
    if get(source,'value') == 1
        set(findobj(gcf,'tag','button2'),'value',0)
        disp(strcat('Valittu:',get(source,'string')))
        
        userdata = get(get(source,'parent'),'userdata');
        userdata.isTouched = 'true';
        set(get(source,'parent'),'userdata',userdata);
        
        current_data.(str) = get(findobj('tag','button1'),'string');
        % Save variables for cross-tabulation
        current_data.vasen = 1;
        current_data.oikea = 0;
    else
        set(findobj(gcf,'tag','button2'),'value',1)
        userdata = get(get(source,'parent'),'userdata');
        userdata.isTouched = 'true';
        set(get(source,'parent'),'userdata',userdata);
        
        current_data.(str) = get(findobj('tag','button2'),'string');
        % Save variables for cross-tabulation
        current_data.vasen = 0;
        current_data.oikea = 1;
    end
else
    if get(source,'value') == 1
        set(findobj(gcf,'tag','button1'),'value',0)
        disp(strcat('Valittu:',get(source,'string')))
        userdata = get(get(source,'parent'),'userdata');
        userdata.isTouched = 'true';
        set(get(source,'parent'),'userdata',userdata);
        
        current_data.(str) = get(findobj('tag','button2'),'string');
        % Save variables for cross-tabulation
        current_data.vasen = 0;
        current_data.oikea = 1;
    else
        set(findobj(gcf,'tag','button1'),'value',1)
        userdata = get(get(source,'parent'),'userdata');
        userdata.isTouched = 'true';
        set(get(source,'parent'),'userdata',userdata);
        
        current_data.(str) = get(findobj('tag','button1'),'string');
        % Save variables for cross-tabulation
        current_data.vasen = 1;
        current_data.oikea = 0;
    end
    
end

% Miscellaneous stuff------------------------------------------------------

% Continue button text-----------------------------------------------------
function continue_button_text(source,~)
set(findobj(gcf,'tag','continue_button'),'string',get(source,'string'))

% Repeat ref checkbox -----------------------------------------------------
function repeat_ref_checkbox(source,~)
if get(source,'value') == 1
    set(findobj(gcf,'tag','repeat_ref_button'),'visible','on')
else
    set(findobj(gcf,'tag','repeat_ref_button'),'visible','off')
end

% Repeat stimulus checkbox-------------------------------------------------
function repeat_stimulus_checkbox(source,~)
if get(source,'value') == 1
    set(findobj(gcf,'tag','repeat_stimulus_button'),'visible','on')
else
    set(findobj(gcf,'tag','repeat_stimulus_button'),'visible','off')
end

% Repeat ref button
function repeat_ref_button(source,~)
global current_bad_ref current_good_ref current_trial reference_monitor data
global reWatch
set(source,'enable','off')
set(findobj(get(source,'parent'),'tag','repeat_stimulus_button'),'enable','off')
set(findobj(get(source,'parent'),'tag','continue_button'),'enable','off')
reWatch = 1;
data.reWatchReferences(current_trial) = data.reWatchReferences(current_trial) + 1;
display_video(current_bad_ref,reference_monitor);
pause(0.5)
display_video(current_good_ref,reference_monitor);
set(source,'enable','on')
set(findobj(get(source,'parent'),'tag','repeat_stimulus_button'),'enable','on')
set(findobj(get(source,'parent'),'tag','continue_button'),'enable','on')

% Repeat stimulus button
function repeat_stimulus_button(source,~)
global current_stimulus data current_trial stimulus_monitor
global reWatch
set(source,'enable','off')
set(findobj(get(source,'parent'),'tag','repeat_ref_button'),'enable','off')
set(findobj(get(source,'parent'),'tag','continue_button'),'enable','off')
reWatch = 1;
data.reWatchStimulus(current_trial) = data.reWatchStimulus(current_trial) + 1;
display_video(current_stimulus,stimulus_monitor);
set(source,'enable','on')
set(findobj(get(source,'parent'),'tag','repeat_ref_button'),'enable','on')
set(findobj(get(source,'parent'),'tag','continue_button'),'enable','on')

% Toolbar functions--------------------------------------------------------

% Mover button
function mover_on(~,~,panel,overlap)
set(panel,'background',[153/255 204/255 50/255])
set(overlap,'visible','on')

function mover_off(~,~,panel,overlap)
set(panel,'background',[0.85 0.85 0.85])
set(overlap,'visible','off')

% Repeat dynamic video ref checkbox ---------------------------------------
function repeat_dynamic_ref_checkbox(source,~)
if get(source,'value') == 1
    set(findobj(gcf,'tag','repeat_dynamic_ref_button'),'visible','on')
else
    set(findobj(gcf,'tag','repeat_dynamic_ref_button'),'visible','off')
end

% Repeat dynamic video ref button------------------------------------------
function repeat_dynamic_ref_button(source,~)
global current_bad_ref current_good_ref current_trial reference_monitor data
global reWatch
set(source,'enable','off')
set(findobj(get(source,'parent'),'tag','continue_button'),'enable','off')
reWatch = 1;
data.reWatchReferences(current_trial) = data.reWatchReferences(current_trial) + 1;
display_video(current_bad_ref,reference_monitor);
pause(0.5)
display_video(current_good_ref,reference_monitor);
set(source,'enable','on')
set(findobj(get(source,'parent'),'tag','continue_button'),'enable','on')

% Repeat Video SSCQE stimulus checkbox-------------------------------------
function repeat_sscqe_stimulus_checkbox(source,~)
if get(source,'value') == 1
    set(findobj(gcf,'tag','repeat_sscqe_stimulus_button'),'visible','on')
else
    set(findobj(gcf,'tag','repeat_sscqe_stimulus_button'),'visible','off')
end

% Repeat Video SSCQE stimulus button---------------------------------------
function repeat_sscqe_stimulus_button(~,~)
global data current_trial test
close(gcf)

data.reWatchStimulus(current_trial) = data.reWatchStimulus(current_trial) + 1;
display_video_sscqe(test.video_file,test.stimulus_monitor,test.question_monitor)

% Repeat pc stimuli checkbox-----------------------------------------------
function repeat_pc_stimuli_checkbox(source,~)
if get(source,'value') == 1
    set(findobj(gcf,'tag','repeat_pc_stimuli_button'),'visible','on')
else
    set(findobj(gcf,'tag','repeat_pc_stimuli_button'),'visible','off')
end

% Repeat pc stimuli button-------------------------------------------------
function repeat_pc_stimuli_button(source,~)
global test setup data

% Disable buttons
set(source,'enable','off')
set(findobj(get(source,'parent'),'tag','continue_button'),'enable','off')

% Display the stimuli
if strcmp(setup.standard,'Still PC')
    display_fullscreen_images_pc(...
        test.file_path1,...
        test.file_path2,...
        test.stimulus1_monitor,...
        test.stimulus2_monitor);
elseif strcmp(setup.standard,'Video PC')
    display_pc_video(...
        test.file_path1,...
        test.file_path2,...
        test.stimulus1_monitor,...
        test.stimulus2_monitor);
end

% Update reWatch counter
data.reWatchStimuli(test.current_trial,:) = ...
    [data.reWatchStimuli(test.current_trial) + 1 ...
    data.reWatchStimuli(test.current_trial) + 1];

% Enable buttons
set(source,'enable','on')
set(findobj(get(source,'parent'),'tag','continue_button'),'enable','on')

% Repeat dynamic still ref checkbox ---------------------------------------
function repeat_dynamic_still_ref_checkbox(source,~)
if get(source,'value') == 1
    set(findobj(gcf,'tag','repeat_dynamic_still_ref_button'),'visible','on')
else
    set(findobj(gcf,'tag','repeat_dynamic_still_ref_button'),'visible','off')
end


% Repeat dynamic still ref button------------------------------------------
function repeat_dynamic_still_ref_button(source,~)
global test data

% Disable buttons
set(source,'enable','off')
set(findobj(get(source,'parent'),'tag','continue_button'),'enable','off')

% Display references
display_stillACR_references()
% Update reWatch counter
data.reWatchReferences(test.current_trial) = ...
    data.reWatchReferences(test.current_trial) + 1;

% Enable buttons
set(source,'enable','on')
set(findobj(get(source,'parent'),'tag','continue_button'),'enable','on')

% Define new window resize function
function window_resize(~,~,left_panel,right_panel)
% Find the right edge of the left panel in pixels
set(left_panel,'units','pixels')
set(right_panel,'units','pixels')
limits = get(left_panel,'position');

% Get the old position for right panel
old_position = get(right_panel,'position');

% Set the right panel's left edge to the limit
set(right_panel,'position',[limits(3)+limits(1)+10 limits(1) ...
    old_position(3) old_position(4)])

% Restore normalized units for the left panel
set(left_panel,'units','normalized')

% Resize question screen callback
function question_screen_width(source,~,panel1)
global setup
new_width = str2num(get(source,'string'));
old_pos = get(panel1,'position');
set(panel1,'position',[old_pos(1) old_pos(2) new_width old_pos(4)])
setup.screens_info43 = new_width;

function question_screen_height(source,~,panel1)
global setup
new_height = str2num(get(source,'string'));
old_pos = get(panel1,'position');
set(panel1,'position',[old_pos(1) old_pos(2) old_pos(3) new_height])
setup.screens_info44 = new_height;













